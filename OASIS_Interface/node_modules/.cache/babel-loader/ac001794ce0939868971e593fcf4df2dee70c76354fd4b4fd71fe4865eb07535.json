{"ast":null,"code":"import ready from './ready.js';\nexport default ((socket, options) => {\n  options = options ?? {};\n  options.closeOnEnd = options.closeOnEnd !== false;\n  const sink = async source => {\n    for await (const data of source) {\n      try {\n        await ready(socket);\n      } catch (err) {\n        if (err.message === 'socket closed') break;\n        throw err;\n      }\n      socket.send(data);\n    }\n    if (options.closeOnEnd != null && socket.readyState <= 1) {\n      return await new Promise((resolve, reject) => {\n        socket.addEventListener('close', event => {\n          if (event.wasClean || event.code === 1006) {\n            resolve();\n          } else {\n            const err = Object.assign(new Error('ws error'), {\n              event\n            });\n            reject(err);\n          }\n        });\n        setTimeout(() => socket.close());\n      });\n    }\n  };\n  return sink;\n});","map":{"version":3,"names":["ready","socket","options","closeOnEnd","sink","source","data","err","message","send","readyState","Promise","resolve","reject","addEventListener","event","wasClean","code","Object","assign","Error","setTimeout","close"],"sources":["../../src/sink.ts"],"sourcesContent":[null],"mappings":"AAAA,OAAOA,KAAK,MAAM,YAAY;AAQ9B,gBAAe,CAACC,MAAiB,EAAEC,OAAoB,KAAI;EACzDA,OAAO,GAAGA,OAAO,IAAI,EAAE;EACvBA,OAAO,CAACC,UAAU,GAAGD,OAAO,CAACC,UAAU,KAAK,KAAK;EAEjD,MAAMC,IAAI,GAAoC,MAAMC,MAAM,IAAG;IAC3D,WAAW,MAAMC,IAAI,IAAID,MAAM,EAAE;MAC/B,IAAI;QACF,MAAML,KAAK,CAACC,MAAM,CAAC;OACpB,CAAC,OAAOM,GAAQ,EAAE;QACjB,IAAIA,GAAG,CAACC,OAAO,KAAK,eAAe,EAAE;QACrC,MAAMD,GAAG;;MAGXN,MAAM,CAACQ,IAAI,CAACH,IAAI,CAAC;;IAGnB,IAAIJ,OAAO,CAACC,UAAU,IAAI,IAAI,IAAIF,MAAM,CAACS,UAAU,IAAI,CAAC,EAAE;MACxD,OAAO,MAAM,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAI;QAC3CZ,MAAM,CAACa,gBAAgB,CAAC,OAAO,EAAEC,KAAK,IAAG;UACvC,IAAIA,KAAK,CAACC,QAAQ,IAAID,KAAK,CAACE,IAAI,KAAK,IAAI,EAAE;YACzCL,OAAO,EAAE;WACV,MAAM;YACL,MAAML,GAAG,GAAGW,MAAM,CAACC,MAAM,CAAC,IAAIC,KAAK,CAAC,UAAU,CAAC,EAAE;cAAEL;YAAK,CAAE,CAAC;YAC3DF,MAAM,CAACN,GAAG,CAAC;;QAEf,CAAC,CAAC;QAEFc,UAAU,CAAC,MAAMpB,MAAM,CAACqB,KAAK,EAAE,CAAC;MAClC,CAAC,CAAC;;EAEN,CAAC;EAED,OAAOlB,IAAI;AACb,CAAC"},"metadata":{},"sourceType":"module","externalDependencies":[]}