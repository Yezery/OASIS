{"ast":null,"code":"import errCode from 'err-code';\nimport { messages, codes } from '../errors.js';\nimport { storeAddresses, uniquePeers, requirePeers } from './utils.js';\nimport drain from 'it-drain';\nimport merge from 'it-merge';\nimport { pipe } from 'it-pipe';\nexport class CompoundContentRouting {\n  constructor(components, init) {\n    this.routers = init.routers ?? [];\n    this.started = false;\n    this.components = components;\n  }\n  isStarted() {\n    return this.started;\n  }\n  async start() {\n    this.started = true;\n  }\n  async stop() {\n    this.started = false;\n  }\n  /**\n   * Iterates over all content routers in parallel to find providers of the given key\n   */\n  async *findProviders(key, options = {}) {\n    if (this.routers.length === 0) {\n      throw errCode(new Error('No content this.routers available'), codes.ERR_NO_ROUTERS_AVAILABLE);\n    }\n    yield* pipe(merge(...this.routers.map(router => router.findProviders(key, options))), source => storeAddresses(source, this.components.peerStore), source => uniquePeers(source), source => requirePeers(source));\n  }\n  /**\n   * Iterates over all content routers in parallel to notify it is\n   * a provider of the given key\n   */\n  async provide(key, options = {}) {\n    if (this.routers.length === 0) {\n      throw errCode(new Error('No content routers available'), codes.ERR_NO_ROUTERS_AVAILABLE);\n    }\n    await Promise.all(this.routers.map(async router => await router.provide(key, options)));\n  }\n  /**\n   * Store the given key/value pair in the available content routings\n   */\n  async put(key, value, options) {\n    if (!this.isStarted()) {\n      throw errCode(new Error(messages.NOT_STARTED_YET), codes.DHT_NOT_STARTED);\n    }\n    const dht = this.components.dht;\n    if (dht != null) {\n      await drain(dht.put(key, value, options));\n    }\n  }\n  /**\n   * Get the value to the given key.\n   * Times out after 1 minute by default.\n   */\n  async get(key, options) {\n    if (!this.isStarted()) {\n      throw errCode(new Error(messages.NOT_STARTED_YET), codes.DHT_NOT_STARTED);\n    }\n    const dht = this.components.dht;\n    if (dht != null) {\n      for await (const event of dht.get(key, options)) {\n        if (event.name === 'VALUE') {\n          return event.value;\n        }\n      }\n    }\n    throw errCode(new Error(messages.NOT_FOUND), codes.ERR_NOT_FOUND);\n  }\n  /**\n   * Get the `n` values to the given key without sorting\n   */\n  async *getMany(key, nVals, options) {\n    if (!this.isStarted()) {\n      throw errCode(new Error(messages.NOT_STARTED_YET), codes.DHT_NOT_STARTED);\n    }\n    if (nVals == null || nVals === 0) {\n      return;\n    }\n    let gotValues = 0;\n    const dht = this.components.dht;\n    if (dht != null) {\n      for await (const event of dht.get(key, options)) {\n        if (event.name === 'VALUE') {\n          yield {\n            from: event.from,\n            val: event.value\n          };\n          gotValues++;\n          if (gotValues === nVals) {\n            break;\n          }\n        }\n      }\n    }\n    if (gotValues === 0) {\n      throw errCode(new Error(messages.NOT_FOUND), codes.ERR_NOT_FOUND);\n    }\n  }\n}","map":{"version":3,"names":["errCode","messages","codes","storeAddresses","uniquePeers","requirePeers","drain","merge","pipe","CompoundContentRouting","constructor","components","init","routers","started","isStarted","start","stop","findProviders","key","options","length","Error","ERR_NO_ROUTERS_AVAILABLE","map","router","source","peerStore","provide","Promise","all","put","value","NOT_STARTED_YET","DHT_NOT_STARTED","dht","get","event","name","NOT_FOUND","ERR_NOT_FOUND","getMany","nVals","gotValues","from","val"],"sources":["../../../src/content-routing/index.ts"],"sourcesContent":[null],"mappings":"AAAA,OAAOA,OAAO,MAAM,UAAU;AAC9B,SAASC,QAAQ,EAAEC,KAAK,QAAQ,cAAc;AAC9C,SACEC,cAAc,EACdC,WAAW,EACXC,YAAY,QACP,YAAY;AACnB,OAAOC,KAAK,MAAM,UAAU;AAC5B,OAAOC,KAAK,MAAM,UAAU;AAC5B,SAASC,IAAI,QAAQ,SAAS;AAiB9B,OAAM,MAAOC,sBAAsB;EAKjCC,YAAaC,UAA4C,EAAEC,IAAgC;IACzF,IAAI,CAACC,OAAO,GAAGD,IAAI,CAACC,OAAO,IAAI,EAAE;IACjC,IAAI,CAACC,OAAO,GAAG,KAAK;IACpB,IAAI,CAACH,UAAU,GAAGA,UAAU;EAC9B;EAEAI,SAASA,CAAA;IACP,OAAO,IAAI,CAACD,OAAO;EACrB;EAEA,MAAME,KAAKA,CAAA;IACT,IAAI,CAACF,OAAO,GAAG,IAAI;EACrB;EAEA,MAAMG,IAAIA,CAAA;IACR,IAAI,CAACH,OAAO,GAAG,KAAK;EACtB;EAEA;;;EAGA,OAAQI,aAAaA,CAAEC,GAAQ,EAAEC,OAAA,GAAwB,EAAE;IACzD,IAAI,IAAI,CAACP,OAAO,CAACQ,MAAM,KAAK,CAAC,EAAE;MAC7B,MAAMrB,OAAO,CAAC,IAAIsB,KAAK,CAAC,mCAAmC,CAAC,EAAEpB,KAAK,CAACqB,wBAAwB,CAAC;;IAG/F,OAAQf,IAAI,CACVD,KAAK,CACH,GAAG,IAAI,CAACM,OAAO,CAACW,GAAG,CAACC,MAAM,IAAIA,MAAM,CAACP,aAAa,CAACC,GAAG,EAAEC,OAAO,CAAC,CAAC,CAClE,EACAM,MAAM,IAAKvB,cAAc,CAACuB,MAAM,EAAE,IAAI,CAACf,UAAU,CAACgB,SAAS,CAAC,EAC5DD,MAAM,IAAKtB,WAAW,CAACsB,MAAM,CAAC,EAC9BA,MAAM,IAAKrB,YAAY,CAACqB,MAAM,CAAC,CACjC;EACH;EAEA;;;;EAIA,MAAME,OAAOA,CAAET,GAAQ,EAAEC,OAAA,GAAwB,EAAE;IACjD,IAAI,IAAI,CAACP,OAAO,CAACQ,MAAM,KAAK,CAAC,EAAE;MAC7B,MAAMrB,OAAO,CAAC,IAAIsB,KAAK,CAAC,8BAA8B,CAAC,EAAEpB,KAAK,CAACqB,wBAAwB,CAAC;;IAG1F,MAAMM,OAAO,CAACC,GAAG,CAAC,IAAI,CAACjB,OAAO,CAACW,GAAG,CAAC,MAAOC,MAAM,IAAK,MAAMA,MAAM,CAACG,OAAO,CAACT,GAAG,EAAEC,OAAO,CAAC,CAAC,CAAC;EAC3F;EAEA;;;EAGA,MAAMW,GAAGA,CAAEZ,GAAe,EAAEa,KAAiB,EAAEZ,OAAsB;IACnE,IAAI,CAAC,IAAI,CAACL,SAAS,EAAE,EAAE;MACrB,MAAMf,OAAO,CAAC,IAAIsB,KAAK,CAACrB,QAAQ,CAACgC,eAAe,CAAC,EAAE/B,KAAK,CAACgC,eAAe,CAAC;;IAG3E,MAAMC,GAAG,GAAG,IAAI,CAACxB,UAAU,CAACwB,GAAG;IAE/B,IAAIA,GAAG,IAAI,IAAI,EAAE;MACf,MAAM7B,KAAK,CAAC6B,GAAG,CAACJ,GAAG,CAACZ,GAAG,EAAEa,KAAK,EAAEZ,OAAO,CAAC,CAAC;;EAE7C;EAEA;;;;EAIA,MAAMgB,GAAGA,CAAEjB,GAAe,EAAEC,OAAsB;IAChD,IAAI,CAAC,IAAI,CAACL,SAAS,EAAE,EAAE;MACrB,MAAMf,OAAO,CAAC,IAAIsB,KAAK,CAACrB,QAAQ,CAACgC,eAAe,CAAC,EAAE/B,KAAK,CAACgC,eAAe,CAAC;;IAG3E,MAAMC,GAAG,GAAG,IAAI,CAACxB,UAAU,CAACwB,GAAG;IAE/B,IAAIA,GAAG,IAAI,IAAI,EAAE;MACf,WAAW,MAAME,KAAK,IAAIF,GAAG,CAACC,GAAG,CAACjB,GAAG,EAAEC,OAAO,CAAC,EAAE;QAC/C,IAAIiB,KAAK,CAACC,IAAI,KAAK,OAAO,EAAE;UAC1B,OAAOD,KAAK,CAACL,KAAK;;;;IAKxB,MAAMhC,OAAO,CAAC,IAAIsB,KAAK,CAACrB,QAAQ,CAACsC,SAAS,CAAC,EAAErC,KAAK,CAACsC,aAAa,CAAC;EACnE;EAEA;;;EAGA,OAAQC,OAAOA,CAAEtB,GAAe,EAAEuB,KAAa,EAAEtB,OAAqB;IACpE,IAAI,CAAC,IAAI,CAACL,SAAS,EAAE,EAAE;MACrB,MAAMf,OAAO,CAAC,IAAIsB,KAAK,CAACrB,QAAQ,CAACgC,eAAe,CAAC,EAAE/B,KAAK,CAACgC,eAAe,CAAC;;IAG3E,IAAIQ,KAAK,IAAI,IAAI,IAAIA,KAAK,KAAK,CAAC,EAAE;MAChC;;IAGF,IAAIC,SAAS,GAAG,CAAC;IACjB,MAAMR,GAAG,GAAG,IAAI,CAACxB,UAAU,CAACwB,GAAG;IAE/B,IAAIA,GAAG,IAAI,IAAI,EAAE;MACf,WAAW,MAAME,KAAK,IAAIF,GAAG,CAACC,GAAG,CAACjB,GAAG,EAAEC,OAAO,CAAC,EAAE;QAC/C,IAAIiB,KAAK,CAACC,IAAI,KAAK,OAAO,EAAE;UAC1B,MAAM;YAAEM,IAAI,EAAEP,KAAK,CAACO,IAAI;YAAEC,GAAG,EAAER,KAAK,CAACL;UAAK,CAAE;UAE5CW,SAAS,EAAE;UAEX,IAAIA,SAAS,KAAKD,KAAK,EAAE;YACvB;;;;;IAMR,IAAIC,SAAS,KAAK,CAAC,EAAE;MACnB,MAAM3C,OAAO,CAAC,IAAIsB,KAAK,CAACrB,QAAQ,CAACsC,SAAS,CAAC,EAAErC,KAAK,CAACsC,aAAa,CAAC;;EAErE"},"metadata":{},"sourceType":"module","externalDependencies":[]}