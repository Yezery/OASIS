{"ast":null,"code":"import _defineProperty from \"/Users/yezery/Oasis/OASIS/node_modules/.store/@babel+runtime@7.22.15/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport { logger } from '@libp2p/logger';\nimport { Device } from './device.js';\nconst log = logger('nat-port-mapper:upnp');\nexport class UPNPClient {\n  static createClient(discoverGateway) {\n    return new UPNPClient(discoverGateway);\n  }\n  constructor(discoverGateway) {\n    _defineProperty(this, \"closed\", void 0);\n    _defineProperty(this, \"discoverGateway\", void 0);\n    _defineProperty(this, \"cancelGatewayDiscovery\", void 0);\n    _defineProperty(this, \"abortController\", void 0);\n    this.discoverGateway = discoverGateway;\n    this.closed = false;\n    // used to terminate network operations on shutdown\n    this.abortController = new AbortController();\n  }\n  async map(options) {\n    if (this.closed) {\n      throw new Error('client is closed');\n    }\n    const gateway = await this.findGateway();\n    const description = options.description ?? 'node:nat:upnp';\n    const protocol = options.protocol === 'TCP' ? options.protocol : 'UDP';\n    let ttl = 60 * 30;\n    if (typeof options.ttl === 'number') {\n      ttl = options.ttl;\n    }\n    if (typeof options.ttl === 'string' && !isNaN(options.ttl)) {\n      ttl = Number(options.ttl);\n    }\n    log('Mapping local port %d to public port %d', options.localPort, options.publicPort);\n    await gateway.run('AddPortMapping', [['NewExternalPort', options.publicPort], ['NewProtocol', protocol], ['NewInternalPort', options.localPort], ['NewInternalClient', options.localAddress], ['NewEnabled', 1], ['NewPortMappingDescription', description], ['NewLeaseDuration', ttl], ['NewProtocol', options.protocol]], this.abortController.signal);\n  }\n  async unmap(options) {\n    if (this.closed) {\n      throw new Error('client is closed');\n    }\n    const gateway = await this.findGateway();\n    await gateway.run('DeletePortMapping', [['NewExternalPort', options.publicPort], ['NewProtocol', options.protocol]], this.abortController.signal);\n  }\n  async externalIp() {\n    if (this.closed) {\n      throw new Error('client is closed');\n    }\n    log('Discover external IP address');\n    const gateway = await this.findGateway();\n    const data = await gateway.run('GetExternalIPAddress', [], this.abortController.signal);\n    let key = null;\n    Object.keys(data).some(function (k) {\n      if (!/:GetExternalIPAddressResponse$/.test(k)) return false;\n      key = k;\n      return true;\n    });\n    if (key == null) {\n      throw new Error('Incorrect response');\n    }\n    log('Discovered external IP address %s', data[key].NewExternalIPAddress);\n    return data[key].NewExternalIPAddress;\n  }\n  async findGateway() {\n    if (this.closed) {\n      throw new Error('client is closed');\n    }\n    const discovery = this.discoverGateway();\n    this.cancelGatewayDiscovery = discovery.cancel;\n    const service = await discovery.gateway();\n    this.cancelGatewayDiscovery = undefined;\n    return new Device(service);\n  }\n  async close() {\n    this.closed = true;\n    this.abortController.abort();\n    if (this.cancelGatewayDiscovery != null) {\n      await this.cancelGatewayDiscovery();\n    }\n  }\n}","map":{"version":3,"names":["logger","Device","log","UPNPClient","createClient","discoverGateway","constructor","_defineProperty","closed","abortController","AbortController","map","options","Error","gateway","findGateway","description","protocol","ttl","isNaN","Number","localPort","publicPort","run","localAddress","signal","unmap","externalIp","data","key","Object","keys","some","k","test","NewExternalIPAddress","discovery","cancelGatewayDiscovery","cancel","service","undefined","close","abort"],"sources":["../../../src/upnp/index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}