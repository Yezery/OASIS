{"ast":null,"code":"import { WebRTCPeer } from './peer.js';\nimport { WebRTCHandshake } from './handshake.js';\nimport randombytes from 'iso-random-stream/src/random.js';\nimport { toString as uint8ArrayToString } from 'uint8arrays/to-string';\nimport { pEvent } from 'p-event';\nimport delay from 'delay';\nimport { CustomEvent } from '@libp2p/interfaces/events';\nimport { logger } from '@libp2p/logger';\nconst log = logger('libp2p:webrtc-peer:initator');\nconst ICECOMPLETE_TIMEOUT = 1000;\nexport class WebRTCInitiator extends WebRTCPeer {\n  constructor(opts = {}) {\n    super({\n      ...opts,\n      logPrefix: 'initiator'\n    });\n    this.handleDataChannelEvent({\n      channel: this.peerConnection.createDataChannel(opts.dataChannelLabel ?? uint8ArrayToString(randombytes(20), 'hex').slice(0, 7), opts.dataChannelInit)\n    });\n    this.handshake = new WebRTCInitiatorHandshake({\n      log: this.log,\n      peerConnection: this.peerConnection,\n      wrtc: this.wrtc,\n      offerOptions: opts.offerOptions\n    });\n    this.handshake.addEventListener('signal', event => {\n      this.dispatchEvent(new CustomEvent('signal', {\n        detail: event.detail\n      }));\n    });\n  }\n  handleSignal(signal) {\n    this.handshake.handleSignal(signal).catch(err => {\n      this.log('error handling signal %o %o', signal, err);\n    });\n  }\n}\nclass WebRTCInitiatorHandshake extends WebRTCHandshake {\n  constructor(options) {\n    super(options);\n    this.options = options;\n    this.status = 'idle';\n    this.peerConnection.addEventListener('icecandidate', event => {\n      if (event.candidate == null) {\n        return;\n      }\n      const signal = {\n        type: 'candidate',\n        candidate: {\n          candidate: event.candidate.candidate,\n          sdpMLineIndex: event.candidate.sdpMLineIndex,\n          sdpMid: event.candidate.sdpMid\n        }\n      };\n      log.trace('create candidate', signal);\n      this.dispatchEvent(new CustomEvent('signal', {\n        detail: signal\n      }));\n      this.dispatchEvent(new CustomEvent('ice-candidate'));\n    });\n  }\n  async handleRenegotiate() {\n    if (this.status === 'negotiating') {\n      this.log('already negotiating, queueing');\n      return;\n    }\n    this.status = 'negotiating';\n    const offer = await this.peerConnection.createOffer(this.options.offerOptions);\n    await this.peerConnection.setLocalDescription(offer);\n    // wait for at least one candidate before sending the offer\n    await pEvent(this, 'ice-candidate');\n    await delay(ICECOMPLETE_TIMEOUT);\n    log.trace('renegotiate', this.peerConnection.localDescription);\n    this.dispatchEvent(new CustomEvent('signal', {\n      detail: this.peerConnection.localDescription ?? offer\n    }));\n  }\n  async handleAnswer(signal) {\n    log.trace('handle answer', signal);\n    await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(signal));\n    this.status = 'idle';\n  }\n}","map":{"version":3,"names":["WebRTCPeer","WebRTCHandshake","randombytes","toString","uint8ArrayToString","pEvent","delay","CustomEvent","logger","log","ICECOMPLETE_TIMEOUT","WebRTCInitiator","constructor","opts","logPrefix","handleDataChannelEvent","channel","peerConnection","createDataChannel","dataChannelLabel","slice","dataChannelInit","handshake","WebRTCInitiatorHandshake","wrtc","offerOptions","addEventListener","event","dispatchEvent","detail","handleSignal","signal","catch","err","options","status","candidate","type","sdpMLineIndex","sdpMid","trace","handleRenegotiate","offer","createOffer","setLocalDescription","localDescription","handleAnswer","setRemoteDescription","RTCSessionDescription"],"sources":["../../src/initiator.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}