{"ast":null,"code":"import _defineProperty from \"/Users/yezery/Oasis/OASIS/node_modules/.store/@babel+runtime@7.22.15/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport \"core-js/modules/es.array.push.js\";\n/**\n * @packageDocumentation\n *\n * An iterable that you can push values into.\n *\n * @example\n *\n * ```js\n * import { pushable } from 'it-pushable'\n *\n * const source = pushable()\n *\n * setTimeout(() => source.push('hello'), 100)\n * setTimeout(() => source.push('world'), 200)\n * setTimeout(() => source.end(), 300)\n *\n * const start = Date.now()\n *\n * for await (const value of source) {\n *   console.log(`got \"${value}\" after ${Date.now() - start}ms`)\n * }\n * console.log(`done after ${Date.now() - start}ms`)\n *\n * // Output:\n * // got \"hello\" after 105ms\n * // got \"world\" after 207ms\n * // done after 309ms\n * ```\n *\n * @example\n *\n * ```js\n * import { pushableV } from 'it-pushable'\n * import all from 'it-all'\n *\n * const source = pushableV()\n *\n * source.push(1)\n * source.push(2)\n * source.push(3)\n * source.end()\n *\n * console.info(await all(source))\n *\n * // Output:\n * // [ [1, 2, 3] ]\n * ```\n */\nimport deferred from 'p-defer';\nimport { FIFO } from './fifo.js';\nexport class AbortError extends Error {\n  constructor(message, code) {\n    super(message ?? 'The operation was aborted');\n    _defineProperty(this, \"type\", void 0);\n    _defineProperty(this, \"code\", void 0);\n    this.type = 'aborted';\n    this.code = code ?? 'ABORT_ERR';\n  }\n}\nexport function pushable(options = {}) {\n  const getNext = buffer => {\n    const next = buffer.shift();\n    if (next == null) {\n      return {\n        done: true\n      };\n    }\n    if (next.error != null) {\n      throw next.error;\n    }\n    return {\n      done: next.done === true,\n      // @ts-expect-error if done is false, value will be present\n      value: next.value\n    };\n  };\n  return _pushable(getNext, options);\n}\nexport function pushableV(options = {}) {\n  const getNext = buffer => {\n    let next;\n    const values = [];\n    while (!buffer.isEmpty()) {\n      next = buffer.shift();\n      if (next == null) {\n        break;\n      }\n      if (next.error != null) {\n        throw next.error;\n      }\n      if (next.done === false) {\n        // @ts-expect-error if done is false value should be pushed\n        values.push(next.value);\n      }\n    }\n    if (next == null) {\n      return {\n        done: true\n      };\n    }\n    return {\n      done: next.done === true,\n      value: values\n    };\n  };\n  return _pushable(getNext, options);\n}\nfunction _pushable(getNext, options) {\n  options = options ?? {};\n  let onEnd = options.onEnd;\n  let buffer = new FIFO();\n  let pushable;\n  let onNext;\n  let ended;\n  let drain = deferred();\n  const waitNext = async () => {\n    try {\n      if (!buffer.isEmpty()) {\n        return getNext(buffer);\n      }\n      if (ended) {\n        return {\n          done: true\n        };\n      }\n      return await new Promise((resolve, reject) => {\n        onNext = next => {\n          onNext = null;\n          buffer.push(next);\n          try {\n            resolve(getNext(buffer));\n          } catch (err) {\n            reject(err);\n          }\n          return pushable;\n        };\n      });\n    } finally {\n      if (buffer.isEmpty()) {\n        // settle promise in the microtask queue to give consumers a chance to\n        // await after calling .push\n        queueMicrotask(() => {\n          drain.resolve();\n          drain = deferred();\n        });\n      }\n    }\n  };\n  const bufferNext = next => {\n    if (onNext != null) {\n      return onNext(next);\n    }\n    buffer.push(next);\n    return pushable;\n  };\n  const bufferError = err => {\n    buffer = new FIFO();\n    if (onNext != null) {\n      return onNext({\n        error: err\n      });\n    }\n    buffer.push({\n      error: err\n    });\n    return pushable;\n  };\n  const push = value => {\n    if (ended) {\n      return pushable;\n    }\n    // @ts-expect-error `byteLength` is not declared on PushType\n    if (options?.objectMode !== true && value?.byteLength == null) {\n      throw new Error('objectMode was not true but tried to push non-Uint8Array value');\n    }\n    return bufferNext({\n      done: false,\n      value\n    });\n  };\n  const end = err => {\n    if (ended) return pushable;\n    ended = true;\n    return err != null ? bufferError(err) : bufferNext({\n      done: true\n    });\n  };\n  const _return = () => {\n    buffer = new FIFO();\n    end();\n    return {\n      done: true\n    };\n  };\n  const _throw = err => {\n    end(err);\n    return {\n      done: true\n    };\n  };\n  pushable = {\n    [Symbol.asyncIterator]() {\n      return this;\n    },\n    next: waitNext,\n    return: _return,\n    throw: _throw,\n    push,\n    end,\n    get readableLength() {\n      return buffer.size;\n    },\n    onEmpty: async options => {\n      const signal = options?.signal;\n      signal?.throwIfAborted();\n      if (buffer.isEmpty()) {\n        return;\n      }\n      let cancel;\n      let listener;\n      if (signal != null) {\n        cancel = new Promise((resolve, reject) => {\n          listener = () => {\n            reject(new AbortError());\n          };\n          signal.addEventListener('abort', listener);\n        });\n      }\n      try {\n        await Promise.race([drain.promise, cancel]);\n      } finally {\n        if (listener != null && signal != null) {\n          signal?.removeEventListener('abort', listener);\n        }\n      }\n    }\n  };\n  if (onEnd == null) {\n    return pushable;\n  }\n  const _pushable = pushable;\n  pushable = {\n    [Symbol.asyncIterator]() {\n      return this;\n    },\n    next() {\n      return _pushable.next();\n    },\n    throw(err) {\n      _pushable.throw(err);\n      if (onEnd != null) {\n        onEnd(err);\n        onEnd = undefined;\n      }\n      return {\n        done: true\n      };\n    },\n    return() {\n      _pushable.return();\n      if (onEnd != null) {\n        onEnd();\n        onEnd = undefined;\n      }\n      return {\n        done: true\n      };\n    },\n    push,\n    end(err) {\n      _pushable.end(err);\n      if (onEnd != null) {\n        onEnd(err);\n        onEnd = undefined;\n      }\n      return pushable;\n    },\n    get readableLength() {\n      return _pushable.readableLength;\n    }\n  };\n  return pushable;\n}","map":{"version":3,"names":["deferred","FIFO","AbortError","Error","constructor","message","code","_defineProperty","type","pushable","options","getNext","buffer","next","shift","done","error","value","_pushable","pushableV","values","isEmpty","push","onEnd","onNext","ended","drain","waitNext","Promise","resolve","reject","err","queueMicrotask","bufferNext","bufferError","objectMode","byteLength","end","_return","_throw","Symbol","asyncIterator","return","throw","readableLength","size","onEmpty","signal","throwIfAborted","cancel","listener","addEventListener","race","promise","removeEventListener","undefined"],"sources":["../../src/index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}