{"ast":null,"code":"import _defineProperty from \"/Users/yezery/Oasis/OASIS/node_modules/.store/@babel+runtime@7.22.15/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport { CodeError } from '@libp2p/interfaces/errors';\nimport { logger } from '@libp2p/logger';\nimport { peerIdFromBytes } from '@libp2p/peer-id';\nimport { anySignal } from 'any-signal';\nimport { CID } from 'multiformats/cid';\nimport defer from 'p-defer';\nimport PQueue from 'p-queue';\nconst log = logger('libp2p:delegated-peer-routing');\nconst DEFAULT_TIMEOUT = 30e3; // 30 second default\nconst CONCURRENT_HTTP_REQUESTS = 4;\nexport var EventTypes;\n(function (EventTypes) {\n  EventTypes[EventTypes[\"SENDING_QUERY\"] = 0] = \"SENDING_QUERY\";\n  EventTypes[EventTypes[\"PEER_RESPONSE\"] = 1] = \"PEER_RESPONSE\";\n  EventTypes[EventTypes[\"FINAL_PEER\"] = 2] = \"FINAL_PEER\";\n  EventTypes[EventTypes[\"QUERY_ERROR\"] = 3] = \"QUERY_ERROR\";\n  EventTypes[EventTypes[\"PROVIDER\"] = 4] = \"PROVIDER\";\n  EventTypes[EventTypes[\"VALUE\"] = 5] = \"VALUE\";\n  EventTypes[EventTypes[\"ADDING_PEER\"] = 6] = \"ADDING_PEER\";\n  EventTypes[EventTypes[\"DIALING_PEER\"] = 7] = \"DIALING_PEER\";\n})(EventTypes || (EventTypes = {}));\n/**\n * The types of messages set/received during DHT queries\n */\nexport var MessageType;\n(function (MessageType) {\n  MessageType[MessageType[\"PUT_VALUE\"] = 0] = \"PUT_VALUE\";\n  MessageType[MessageType[\"GET_VALUE\"] = 1] = \"GET_VALUE\";\n  MessageType[MessageType[\"ADD_PROVIDER\"] = 2] = \"ADD_PROVIDER\";\n  MessageType[MessageType[\"GET_PROVIDERS\"] = 3] = \"GET_PROVIDERS\";\n  MessageType[MessageType[\"FIND_NODE\"] = 4] = \"FIND_NODE\";\n  MessageType[MessageType[\"PING\"] = 5] = \"PING\";\n})(MessageType || (MessageType = {}));\nclass DelegatedPeerRouting {\n  /**\n   * Create a new DelegatedPeerRouting instance\n   */\n  constructor(client) {\n    _defineProperty(this, \"client\", void 0);\n    _defineProperty(this, \"httpQueue\", void 0);\n    _defineProperty(this, \"started\", void 0);\n    _defineProperty(this, \"abortController\", void 0);\n    if (client == null) {\n      throw new Error('missing ipfs http client');\n    }\n    this.client = client;\n    this.started = false;\n    this.abortController = new AbortController();\n    // limit concurrency to avoid request flood in web browser\n    // https://github.com/libp2p/js-libp2p-delegated-content-routing/issues/12\n    this.httpQueue = new PQueue({\n      concurrency: CONCURRENT_HTTP_REQUESTS\n    });\n    const {\n      protocol,\n      host,\n      port\n    } = client.getEndpointConfig();\n    log(`enabled DelegatedPeerRouting via ${protocol}://${host}:${port}`);\n  }\n  isStarted() {\n    return this.started;\n  }\n  start() {\n    this.started = true;\n  }\n  stop() {\n    this.httpQueue.clear();\n    this.abortController.abort();\n    this.abortController = new AbortController();\n    this.started = false;\n  }\n  /**\n   * Attempts to find the given peer\n   */\n  async findPeer(id, options = {}) {\n    log('findPeer starts: %p', id);\n    options.timeout = options.timeout ?? DEFAULT_TIMEOUT;\n    const signal = anySignal([this.abortController.signal, options.signal]);\n    const onStart = defer();\n    const onFinish = defer();\n    void this.httpQueue.add(async () => {\n      onStart.resolve();\n      return onFinish.promise;\n    });\n    try {\n      await onStart.promise;\n      for await (const event of this.client.dht.findPeer(id, {\n        ...options,\n        signal\n      })) {\n        if (event.name === 'FINAL_PEER' && event.peer.multiaddrs.length > 0) {\n          const peerInfo = {\n            id: event.peer.id,\n            multiaddrs: event.peer.multiaddrs,\n            protocols: []\n          };\n          return peerInfo;\n        }\n      }\n      throw new CodeError('Not found', 'ERR_NOT_FOUND');\n    } catch (err) {\n      log.error('findPeer errored: %o', err);\n      throw err;\n    } finally {\n      signal.clear();\n      onFinish.resolve();\n      log('findPeer finished: %p', id);\n    }\n  }\n  /**\n   * Attempt to find the closest peers on the network to the given key\n   */\n  async *getClosestPeers(key, options = {}) {\n    let cidOrPeerId;\n    const cid = CID.asCID(key);\n    if (cid != null) {\n      cidOrPeerId = cid;\n    } else {\n      cidOrPeerId = peerIdFromBytes(key);\n    }\n    log('getClosestPeers starts: %s', cidOrPeerId);\n    options.timeout = options.timeout ?? DEFAULT_TIMEOUT;\n    const signal = anySignal([this.abortController.signal, options.signal]);\n    const onStart = defer();\n    const onFinish = defer();\n    void this.httpQueue.add(async () => {\n      onStart.resolve();\n      return onFinish.promise;\n    });\n    try {\n      await onStart.promise;\n      for await (const event of this.client.dht.query(cidOrPeerId, {\n        ...options,\n        signal\n      })) {\n        if (event.name === 'PEER_RESPONSE') {\n          yield* event.closer.map(closer => ({\n            id: closer.id,\n            multiaddrs: closer.multiaddrs,\n            protocols: []\n          }));\n        }\n      }\n    } catch (err) {\n      log.error('getClosestPeers errored:', err);\n      throw err;\n    } finally {\n      signal.clear();\n      onFinish.resolve();\n      log('getClosestPeers finished: %b', key);\n    }\n  }\n}\nexport function delegatedPeerRouting(client) {\n  return () => new DelegatedPeerRouting(client);\n}","map":{"version":3,"names":["CodeError","logger","peerIdFromBytes","anySignal","CID","defer","PQueue","log","DEFAULT_TIMEOUT","CONCURRENT_HTTP_REQUESTS","EventTypes","MessageType","DelegatedPeerRouting","constructor","client","_defineProperty","Error","started","abortController","AbortController","httpQueue","concurrency","protocol","host","port","getEndpointConfig","isStarted","start","stop","clear","abort","findPeer","id","options","timeout","signal","onStart","onFinish","add","resolve","promise","event","dht","name","peer","multiaddrs","length","peerInfo","protocols","err","error","getClosestPeers","key","cidOrPeerId","cid","asCID","query","closer","map","delegatedPeerRouting"],"sources":["../../src/index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}