{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { abortableSource } from 'abortable-iterator';\nimport { pipe } from 'it-pipe';\nimport { pushable } from 'it-pushable';\nimport { encode, decode } from 'it-length-prefixed';\nexport class OutboundStream {\n  constructor(rawStream, errCallback, opts) {\n    this.rawStream = rawStream;\n    this.pushable = pushable({\n      objectMode: false\n    });\n    this.closeController = new AbortController();\n    this.maxBufferSize = opts.maxBufferSize ?? Infinity;\n    pipe(abortableSource(this.pushable, this.closeController.signal, {\n      returnOnAbort: true\n    }), encode(), this.rawStream).catch(errCallback);\n  }\n  get protocol() {\n    // TODO remove this non-nullish assertion after https://github.com/libp2p/js-libp2p-interfaces/pull/265 is incorporated\n    return this.rawStream.stat.protocol;\n  }\n  push(data) {\n    if (this.pushable.readableLength > this.maxBufferSize) {\n      throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);\n    }\n    this.pushable.push(data);\n  }\n  close() {\n    this.closeController.abort();\n    // similar to pushable.end() but clear the internal buffer\n    this.pushable.return();\n    this.rawStream.close();\n  }\n}\nexport class InboundStream {\n  constructor(rawStream, opts = {}) {\n    this.rawStream = rawStream;\n    this.closeController = new AbortController();\n    this.source = abortableSource(pipe(this.rawStream, decode(opts)), this.closeController.signal, {\n      returnOnAbort: true\n    });\n  }\n  close() {\n    this.closeController.abort();\n    this.rawStream.close();\n  }\n}","map":{"version":3,"names":["abortableSource","pipe","pushable","encode","decode","OutboundStream","constructor","rawStream","errCallback","opts","objectMode","closeController","AbortController","maxBufferSize","Infinity","signal","returnOnAbort","catch","protocol","stat","push","data","readableLength","Error","close","abort","return","InboundStream","source"],"sources":["../../src/stream.ts"],"sourcesContent":[null],"mappings":";AACA,SAASA,eAAe,QAAQ,oBAAoB;AACpD,SAASC,IAAI,QAAQ,SAAS;AAC9B,SAASC,QAAQ,QAAkB,aAAa;AAChD,SAASC,MAAM,EAAEC,MAAM,QAAQ,oBAAoB;AAanD,OAAM,MAAOC,cAAc;EAKzBC,YAA6BC,SAAiB,EAAEC,WAA+B,EAAEC,IAAwB;IAA5E,KAAAF,SAAS,GAATA,SAAS;IACpC,IAAI,CAACL,QAAQ,GAAGA,QAAQ,CAAC;MAAEQ,UAAU,EAAE;IAAK,CAAE,CAAC;IAC/C,IAAI,CAACC,eAAe,GAAG,IAAIC,eAAe,EAAE;IAC5C,IAAI,CAACC,aAAa,GAAGJ,IAAI,CAACI,aAAa,IAAIC,QAAQ;IAEnDb,IAAI,CACFD,eAAe,CAAC,IAAI,CAACE,QAAQ,EAAE,IAAI,CAACS,eAAe,CAACI,MAAM,EAAE;MAAEC,aAAa,EAAE;IAAI,CAAE,CAAC,EACpFb,MAAM,EAAE,EACR,IAAI,CAACI,SAAS,CACf,CAACU,KAAK,CAACT,WAAW,CAAC;EACtB;EAEA,IAAIU,QAAQA,CAAA;IACV;IACA,OAAO,IAAI,CAACX,SAAS,CAACY,IAAI,CAACD,QAAS;EACtC;EAEAE,IAAIA,CAACC,IAAgB;IACnB,IAAI,IAAI,CAACnB,QAAQ,CAACoB,cAAc,GAAG,IAAI,CAACT,aAAa,EAAE;MACrD,MAAMU,KAAK,CAAC,sCAAsC,IAAI,CAACV,aAAa,EAAE,CAAC;;IAGzE,IAAI,CAACX,QAAQ,CAACkB,IAAI,CAACC,IAAI,CAAC;EAC1B;EAEAG,KAAKA,CAAA;IACH,IAAI,CAACb,eAAe,CAACc,KAAK,EAAE;IAC5B;IACA,IAAI,CAACvB,QAAQ,CAACwB,MAAM,EAAE;IACtB,IAAI,CAACnB,SAAS,CAACiB,KAAK,EAAE;EACxB;;AAGF,OAAM,MAAOG,aAAa;EAMxBrB,YAAYC,SAAiB,EAAEE,IAAA,GAA0B,EAAE;IACzD,IAAI,CAACF,SAAS,GAAGA,SAAS;IAC1B,IAAI,CAACI,eAAe,GAAG,IAAIC,eAAe,EAAE;IAE5C,IAAI,CAACgB,MAAM,GAAG5B,eAAe,CAACC,IAAI,CAAC,IAAI,CAACM,SAAS,EAAEH,MAAM,CAACK,IAAI,CAAC,CAAC,EAAE,IAAI,CAACE,eAAe,CAACI,MAAM,EAAE;MAC7FC,aAAa,EAAE;KAChB,CAAC;EACJ;EAEAQ,KAAKA,CAAA;IACH,IAAI,CAACb,eAAe,CAACc,KAAK,EAAE;IAC5B,IAAI,CAAClB,SAAS,CAACiB,KAAK,EAAE;EACxB"},"metadata":{},"sourceType":"module","externalDependencies":[]}