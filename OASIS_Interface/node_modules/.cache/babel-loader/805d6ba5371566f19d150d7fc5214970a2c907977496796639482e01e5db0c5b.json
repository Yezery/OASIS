{"ast":null,"code":"import _defineProperty from \"/Users/yezery/Oasis/OASIS/node_modules/.store/@babel+runtime@7.22.15/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport \"core-js/modules/web.url-search-params.delete.js\";\nimport \"core-js/modules/web.url-search-params.has.js\";\nimport \"core-js/modules/web.url-search-params.size.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport { logger } from '@libp2p/logger';\nimport xml2js from 'xml2js';\nimport { fetchXML } from './fetch.js';\nconst log = logger('nat-port-mapper:upnp:device');\nexport class Device {\n  constructor(service) {\n    _defineProperty(this, \"service\", void 0);\n    _defineProperty(this, \"services\", void 0);\n    this.service = service;\n    this.services = ['urn:schemas-upnp-org:service:WANIPConnection:1', 'urn:schemas-upnp-org:service:WANIPConnection:2', 'urn:schemas-upnp-org:service:WANPPPConnection:1'];\n  }\n  async run(action, args, signal) {\n    const info = this.getService(this.services);\n    const requestBody = `<?xml version=\"1.0\"?>\n<s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\" s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\">\n  <s:Body>\n    <u:${action} xmlns:u=\"${info.service}\">${args.map(args => `\n      <${args[0]}>${args[1] != null ? args[1] : ''}</${args[0]}>`).join('')}\n    </u:${action}>\n  </s:Body>\n</s:Envelope>`;\n    log.trace('-> POST', info.controlURL);\n    log.trace('->', requestBody);\n    const text = await fetchXML(new URL(info.controlURL), {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'text/xml',\n        'Content-Length': requestBody.length.toString(),\n        SOAPAction: JSON.stringify(info.service + '#' + action)\n      },\n      body: requestBody,\n      signal\n    });\n    log.trace('<-', text);\n    const parser = new xml2js.Parser({\n      explicitRoot: false,\n      explicitArray: false,\n      attrkey: '@'\n    });\n    const responseBody = await parser.parseStringPromise(text);\n    const soapns = this.getNamespace(responseBody, 'http://schemas.xmlsoap.org/soap/envelope/');\n    return responseBody[soapns + 'Body'];\n  }\n  getService(types) {\n    const [service] = this.parseDescription(this.service.details).services.filter(function (service) {\n      return types.includes(service.serviceType);\n    });\n    // Use the first available service\n    if (service == null || service.controlURL == null || service.SCPDURL == null) {\n      throw new Error('Service not found');\n    }\n    const base = new URL(this.service.location);\n    function addPrefix(u) {\n      let uri;\n      try {\n        uri = new URL(u);\n      } catch (err) {\n        // Is only the path of the URL\n        uri = new URL(u, base.href);\n      }\n      uri.host = uri.host ?? base.host;\n      uri.protocol = uri.protocol ?? base.protocol;\n      return uri.toString();\n    }\n    return {\n      service: service.serviceType,\n      SCPDURL: addPrefix(service.SCPDURL),\n      controlURL: addPrefix(service.controlURL)\n    };\n  }\n  parseDescription(info) {\n    const services = [];\n    const devices = [];\n    function toArray(item) {\n      return Array.isArray(item) ? item : [item];\n    }\n    function traverseServices(service) {\n      if (service == null) {\n        return;\n      }\n      services.push(service);\n    }\n    function traverseDevices(device) {\n      if (device == null) {\n        return;\n      }\n      devices.push(device);\n      if (device.deviceList?.device != null) {\n        toArray(device.deviceList.device).forEach(traverseDevices);\n      }\n      if (device.serviceList?.service != null) {\n        toArray(device.serviceList.service).forEach(traverseServices);\n      }\n    }\n    traverseDevices(info.device);\n    return {\n      services,\n      devices\n    };\n  }\n  getNamespace(data, uri) {\n    let ns;\n    if (data['@'] != null) {\n      Object.keys(data['@']).some(function (key) {\n        if (!/^xmlns:/.test(key)) return false;\n        if (data['@'][key] !== uri) return false;\n        ns = key.replace(/^xmlns:/, '');\n        return true;\n      });\n    }\n    return ns != null ? `${ns}:` : '';\n  }\n}","map":{"version":3,"names":["logger","xml2js","fetchXML","log","Device","constructor","service","_defineProperty","services","run","action","args","signal","info","getService","requestBody","map","join","trace","controlURL","text","URL","method","headers","length","toString","SOAPAction","JSON","stringify","body","parser","Parser","explicitRoot","explicitArray","attrkey","responseBody","parseStringPromise","soapns","getNamespace","types","parseDescription","details","filter","includes","serviceType","SCPDURL","Error","base","location","addPrefix","u","uri","err","href","host","protocol","devices","toArray","item","Array","isArray","traverseServices","push","traverseDevices","device","deviceList","forEach","serviceList","data","ns","Object","keys","some","key","test","replace"],"sources":["../../../src/upnp/device.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}