{"ast":null,"code":"import { Libp2pRecord } from '@libp2p/record';\nimport { CodeError } from '@libp2p/interfaces/errors';\nimport { Message, MESSAGE_TYPE } from '../../message/index.js';\nimport { MAX_RECORD_AGE } from '../../constants.js';\nimport { bufferToRecordKey, isPublicKeyKey, fromPublicKeyKey } from '../../utils.js';\nimport { logger } from '@libp2p/logger';\nconst log = logger('libp2p:kad-dht:rpc:handlers:get-value');\nexport class GetValueHandler {\n  constructor(components, init) {\n    const {\n      peerRouting\n    } = init;\n    this.components = components;\n    this.peerRouting = peerRouting;\n  }\n  async handle(peerId, msg) {\n    const key = msg.key;\n    log('%p asked for key %b', peerId, key);\n    if (key == null || key.length === 0) {\n      throw new CodeError('Invalid key', 'ERR_INVALID_KEY');\n    }\n    const response = new Message(MESSAGE_TYPE.GET_VALUE, key, msg.clusterLevel);\n    if (isPublicKeyKey(key)) {\n      log('is public key');\n      const idFromKey = fromPublicKeyKey(key);\n      let pubKey;\n      try {\n        const key = await this.components.peerStore.keyBook.get(idFromKey);\n        if (key == null) {\n          throw new CodeError('No public key found in key book', 'ERR_NOT_FOUND');\n        }\n        pubKey = key;\n      } catch (err) {\n        if (err.code !== 'ERR_NOT_FOUND') {\n          throw err;\n        }\n      }\n      if (pubKey != null) {\n        log('returning found public key');\n        response.record = new Libp2pRecord(key, pubKey, new Date());\n        return response;\n      }\n    }\n    const [record, closer] = await Promise.all([this._checkLocalDatastore(key), this.peerRouting.getCloserPeersOffline(msg.key, peerId)]);\n    if (record != null) {\n      log('had record for %b in local datastore', key);\n      response.record = record;\n    }\n    if (closer.length > 0) {\n      log('had %s closer peers in routing table', closer.length);\n      response.closerPeers = closer;\n    }\n    return response;\n  }\n  /**\n   * Try to fetch a given record by from the local datastore.\n   * Returns the record if it is still valid, meaning\n   * - it was either authored by this node, or\n   * - it was received less than `MAX_RECORD_AGE` ago.\n   */\n  async _checkLocalDatastore(key) {\n    log('checkLocalDatastore looking for %b', key);\n    const dsKey = bufferToRecordKey(key);\n    // Fetch value from ds\n    let rawRecord;\n    try {\n      rawRecord = await this.components.datastore.get(dsKey);\n    } catch (err) {\n      if (err.code === 'ERR_NOT_FOUND') {\n        return undefined;\n      }\n      throw err;\n    }\n    // Create record from the returned bytes\n    const record = Libp2pRecord.deserialize(rawRecord);\n    if (record == null) {\n      throw new CodeError('Invalid record', 'ERR_INVALID_RECORD');\n    }\n    // Check validity: compare time received with max record age\n    if (record.timeReceived == null || Date.now() - record.timeReceived.getTime() > MAX_RECORD_AGE) {\n      // If record is bad delete it and return\n      await this.components.datastore.delete(dsKey);\n      return undefined;\n    }\n    // Record is valid\n    return record;\n  }\n}","map":{"version":3,"names":["Libp2pRecord","CodeError","Message","MESSAGE_TYPE","MAX_RECORD_AGE","bufferToRecordKey","isPublicKeyKey","fromPublicKeyKey","logger","log","GetValueHandler","constructor","components","init","peerRouting","handle","peerId","msg","key","length","response","GET_VALUE","clusterLevel","idFromKey","pubKey","peerStore","keyBook","get","err","code","record","Date","closer","Promise","all","_checkLocalDatastore","getCloserPeersOffline","closerPeers","dsKey","rawRecord","datastore","undefined","deserialize","timeReceived","now","getTime","delete"],"sources":["../../../../src/rpc/handlers/get-value.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}