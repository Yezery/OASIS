{"ast":null,"code":"import { pushable } from 'it-pushable';\nimport merge from 'it-merge';\nexport const rawPipe = (...fns) => {\n  let res;\n  while (fns.length > 0) {\n    res = fns.shift()(res);\n  }\n  return res;\n};\nexport const isIterable = obj => {\n  return obj != null && (typeof obj[Symbol.asyncIterator] === 'function' || typeof obj[Symbol.iterator] === 'function' || typeof obj.next === 'function' // Probably, right?\n  );\n};\n\nexport const isDuplex = obj => {\n  return obj != null && typeof obj.sink === 'function' && isIterable(obj.source);\n};\nconst duplexPipelineFn = duplex => {\n  return source => {\n    const p = duplex.sink(source);\n    if (p.then != null) {\n      const stream = pushable({\n        objectMode: true\n      });\n      p.then(() => {\n        stream.end();\n      }, err => {\n        stream.end(err);\n      });\n      const sourceWrap = async function* () {\n        yield* duplex.source;\n        stream.end();\n      };\n      return merge(stream, sourceWrap());\n    }\n    return duplex.source;\n  };\n};\nexport function pipe(first, ...rest) {\n  // Duplex at start: wrap in function and return duplex source\n  if (isDuplex(first)) {\n    const duplex = first;\n    first = () => duplex.source;\n    // Iterable at start: wrap in function\n  } else if (isIterable(first)) {\n    const source = first;\n    first = () => source;\n  }\n  const fns = [first, ...rest];\n  if (fns.length > 1) {\n    // Duplex at end: use duplex sink\n    if (isDuplex(fns[fns.length - 1])) {\n      fns[fns.length - 1] = fns[fns.length - 1].sink;\n    }\n  }\n  if (fns.length > 2) {\n    // Duplex in the middle, consume source with duplex sink and return duplex source\n    for (let i = 1; i < fns.length - 1; i++) {\n      if (isDuplex(fns[i])) {\n        fns[i] = duplexPipelineFn(fns[i]);\n      }\n    }\n  }\n  return rawPipe(...fns);\n}","map":{"version":3,"names":["pushable","merge","rawPipe","fns","res","length","shift","isIterable","obj","Symbol","asyncIterator","iterator","next","isDuplex","sink","source","duplexPipelineFn","duplex","p","then","stream","objectMode","end","err","sourceWrap","pipe","first","rest","i"],"sources":["../../src/index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}