{"ast":null,"code":"import { ERR_INVALID_PEER_SCORE_PARAMS } from './constants.js';\nimport { CodeError } from '@libp2p/interfaces/errors';\nexport const defaultPeerScoreParams = {\n  topics: {},\n  topicScoreCap: 10.0,\n  appSpecificScore: () => 0.0,\n  appSpecificWeight: 10.0,\n  IPColocationFactorWeight: -5.0,\n  IPColocationFactorThreshold: 10.0,\n  IPColocationFactorWhitelist: new Set(),\n  behaviourPenaltyWeight: -10.0,\n  behaviourPenaltyThreshold: 0.0,\n  behaviourPenaltyDecay: 0.2,\n  decayInterval: 1000.0,\n  decayToZero: 0.1,\n  retainScore: 3600 * 1000\n};\nexport const defaultTopicScoreParams = {\n  topicWeight: 0.5,\n  timeInMeshWeight: 1,\n  timeInMeshQuantum: 1,\n  timeInMeshCap: 3600,\n  firstMessageDeliveriesWeight: 1,\n  firstMessageDeliveriesDecay: 0.5,\n  firstMessageDeliveriesCap: 2000,\n  meshMessageDeliveriesWeight: -1,\n  meshMessageDeliveriesDecay: 0.5,\n  meshMessageDeliveriesCap: 100,\n  meshMessageDeliveriesThreshold: 20,\n  meshMessageDeliveriesWindow: 10,\n  meshMessageDeliveriesActivation: 5000,\n  meshFailurePenaltyWeight: -1,\n  meshFailurePenaltyDecay: 0.5,\n  invalidMessageDeliveriesWeight: -1,\n  invalidMessageDeliveriesDecay: 0.3\n};\nexport function createPeerScoreParams(p = {}) {\n  return {\n    ...defaultPeerScoreParams,\n    ...p,\n    topics: p.topics ? Object.entries(p.topics).reduce((topics, [topic, topicScoreParams]) => {\n      topics[topic] = createTopicScoreParams(topicScoreParams);\n      return topics;\n    }, {}) : {}\n  };\n}\nexport function createTopicScoreParams(p = {}) {\n  return {\n    ...defaultTopicScoreParams,\n    ...p\n  };\n}\n// peer score parameter validation\nexport function validatePeerScoreParams(p) {\n  for (const [topic, params] of Object.entries(p.topics)) {\n    try {\n      validateTopicScoreParams(params);\n    } catch (e) {\n      throw new CodeError(`invalid score parameters for topic ${topic}: ${e.message}`, ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n  }\n  // check that the topic score is 0 or something positive\n  if (p.topicScoreCap < 0) {\n    throw new CodeError('invalid topic score cap; must be positive (or 0 for no cap)', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check that we have an app specific score; the weight can be anything (but expected positive)\n  if (p.appSpecificScore === null || p.appSpecificScore === undefined) {\n    throw new CodeError('missing application specific score function', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check the IP colocation factor\n  if (p.IPColocationFactorWeight > 0) {\n    throw new CodeError('invalid IPColocationFactorWeight; must be negative (or 0 to disable)', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.IPColocationFactorWeight !== 0 && p.IPColocationFactorThreshold < 1) {\n    throw new CodeError('invalid IPColocationFactorThreshold; must be at least 1', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check the behaviour penalty\n  if (p.behaviourPenaltyWeight > 0) {\n    throw new CodeError('invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.behaviourPenaltyWeight !== 0 && (p.behaviourPenaltyDecay <= 0 || p.behaviourPenaltyDecay >= 1)) {\n    throw new CodeError('invalid BehaviourPenaltyDecay; must be between 0 and 1', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check the decay parameters\n  if (p.decayInterval < 1000) {\n    throw new CodeError('invalid DecayInterval; must be at least 1s', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.decayToZero <= 0 || p.decayToZero >= 1) {\n    throw new CodeError('invalid DecayToZero; must be between 0 and 1', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // no need to check the score retention; a value of 0 means that we don't retain scores\n}\n\nexport function validateTopicScoreParams(p) {\n  // make sure we have a sane topic weight\n  if (p.topicWeight < 0) {\n    throw new CodeError('invalid topic weight; must be >= 0', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check P1\n  if (p.timeInMeshQuantum === 0) {\n    throw new CodeError('invalid TimeInMeshQuantum; must be non zero', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.timeInMeshWeight < 0) {\n    throw new CodeError('invalid TimeInMeshWeight; must be positive (or 0 to disable)', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.timeInMeshWeight !== 0 && p.timeInMeshQuantum <= 0) {\n    throw new CodeError('invalid TimeInMeshQuantum; must be positive', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.timeInMeshWeight !== 0 && p.timeInMeshCap <= 0) {\n    throw new CodeError('invalid TimeInMeshCap; must be positive', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check P2\n  if (p.firstMessageDeliveriesWeight < 0) {\n    throw new CodeError('invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.firstMessageDeliveriesWeight !== 0 && (p.firstMessageDeliveriesDecay <= 0 || p.firstMessageDeliveriesDecay >= 1)) {\n    throw new CodeError('invalid FirstMessageDeliveriesDecay; must be between 0 and 1', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.firstMessageDeliveriesWeight !== 0 && p.firstMessageDeliveriesCap <= 0) {\n    throw new CodeError('invalid FirstMessageDeliveriesCap; must be positive', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check P3\n  if (p.meshMessageDeliveriesWeight > 0) {\n    throw new CodeError('invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.meshMessageDeliveriesWeight !== 0 && (p.meshMessageDeliveriesDecay <= 0 || p.meshMessageDeliveriesDecay >= 1)) {\n    throw new CodeError('invalid MeshMessageDeliveriesDecay; must be between 0 and 1', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesCap <= 0) {\n    throw new CodeError('invalid MeshMessageDeliveriesCap; must be positive', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesThreshold <= 0) {\n    throw new CodeError('invalid MeshMessageDeliveriesThreshold; must be positive', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.meshMessageDeliveriesWindow < 0) {\n    throw new CodeError('invalid MeshMessageDeliveriesWindow; must be non-negative', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesActivation < 1000) {\n    throw new CodeError('invalid MeshMessageDeliveriesActivation; must be at least 1s', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check P3b\n  if (p.meshFailurePenaltyWeight > 0) {\n    throw new CodeError('invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.meshFailurePenaltyWeight !== 0 && (p.meshFailurePenaltyDecay <= 0 || p.meshFailurePenaltyDecay >= 1)) {\n    throw new CodeError('invalid MeshFailurePenaltyDecay; must be between 0 and 1', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  // check P4\n  if (p.invalidMessageDeliveriesWeight > 0) {\n    throw new CodeError('invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n  if (p.invalidMessageDeliveriesDecay <= 0 || p.invalidMessageDeliveriesDecay >= 1) {\n    throw new CodeError('invalid InvalidMessageDeliveriesDecay; must be between 0 and 1', ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n}","map":{"version":3,"names":["ERR_INVALID_PEER_SCORE_PARAMS","CodeError","defaultPeerScoreParams","topics","topicScoreCap","appSpecificScore","appSpecificWeight","IPColocationFactorWeight","IPColocationFactorThreshold","IPColocationFactorWhitelist","Set","behaviourPenaltyWeight","behaviourPenaltyThreshold","behaviourPenaltyDecay","decayInterval","decayToZero","retainScore","defaultTopicScoreParams","topicWeight","timeInMeshWeight","timeInMeshQuantum","timeInMeshCap","firstMessageDeliveriesWeight","firstMessageDeliveriesDecay","firstMessageDeliveriesCap","meshMessageDeliveriesWeight","meshMessageDeliveriesDecay","meshMessageDeliveriesCap","meshMessageDeliveriesThreshold","meshMessageDeliveriesWindow","meshMessageDeliveriesActivation","meshFailurePenaltyWeight","meshFailurePenaltyDecay","invalidMessageDeliveriesWeight","invalidMessageDeliveriesDecay","createPeerScoreParams","p","Object","entries","reduce","topic","topicScoreParams","createTopicScoreParams","validatePeerScoreParams","params","validateTopicScoreParams","e","message","undefined"],"sources":["../../../src/score/peer-score-params.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}