{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { WebRTCPeer } from './peer.js';\nimport { WebRTCHandshake } from './handshake.js';\nimport { CustomEvent } from '@libp2p/interfaces/events';\nimport { logger } from '@libp2p/logger';\nconst log = logger('libp2p:webrtc-peer:receiver');\nexport class WebRTCReceiver extends WebRTCPeer {\n  constructor(opts = {}) {\n    super({\n      ...opts,\n      logPrefix: 'receiver'\n    });\n    this.handshake = new WebRTCReceiverHandshake({\n      log: this.log,\n      peerConnection: this.peerConnection,\n      wrtc: this.wrtc,\n      answerOptions: opts.answerOptions\n    });\n    this.handshake.addEventListener('signal', event => this.dispatchEvent(new CustomEvent('signal', {\n      detail: event.detail\n    })));\n    this.peerConnection.addEventListener('datachannel', event => {\n      this.handleDataChannelEvent(event);\n    });\n  }\n  handleSignal(signal) {\n    this.handshake.handleSignal(signal).catch(err => {\n      this.log('error handling signal %o %o', signal, err);\n    });\n  }\n}\nclass WebRTCReceiverHandshake extends WebRTCHandshake {\n  constructor(options) {\n    super(options);\n    this.options = options;\n    this.status = 'idle';\n    this.iceCandidates = [];\n  }\n  async handleRenegotiate() {\n    log.trace('renegotiate');\n    this.dispatchEvent(new CustomEvent('signal', {\n      detail: {\n        type: 'renegotiate'\n      }\n    }));\n  }\n  async handleOffer(signal) {\n    await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(signal));\n    // add any candidates we were sent before the offer arrived\n    for (const candidate of this.iceCandidates) {\n      await this.handleCandidate(candidate);\n    }\n    this.iceCandidates = [];\n    const answer = await this.peerConnection.createAnswer(this.options.answerOptions);\n    await this.peerConnection.setLocalDescription(answer);\n    log.trace('handle offer', this.peerConnection.localDescription);\n    this.dispatchEvent(new CustomEvent('signal', {\n      detail: this.peerConnection.localDescription ?? answer\n    }));\n  }\n  async handleCandidate(signal) {\n    if (this.peerConnection.remoteDescription == null || this.peerConnection.remoteDescription.type == null) {\n      // we haven't been sent an offer yet, cache the remote ICE candidates\n      this.iceCandidates.push(signal);\n      return;\n    }\n    await super.handleCandidate(signal);\n  }\n}","map":{"version":3,"names":["WebRTCPeer","WebRTCHandshake","CustomEvent","logger","log","WebRTCReceiver","constructor","opts","logPrefix","handshake","WebRTCReceiverHandshake","peerConnection","wrtc","answerOptions","addEventListener","event","dispatchEvent","detail","handleDataChannelEvent","handleSignal","signal","catch","err","options","status","iceCandidates","handleRenegotiate","trace","type","handleOffer","setRemoteDescription","RTCSessionDescription","candidate","handleCandidate","answer","createAnswer","setLocalDescription","localDescription","remoteDescription","push"],"sources":["../../src/receiver.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}