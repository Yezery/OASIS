{"ast":null,"code":"import \"core-js/modules/es.typed-array.to-reversed.js\";\nimport \"core-js/modules/es.typed-array.to-sorted.js\";\nimport \"core-js/modules/es.typed-array.with.js\";\nimport { logger } from '@libp2p/logger';\nimport { CodeError } from '@libp2p/interfaces/errors';\nimport { codes } from './errors.js';\nimport { peerIdFromPeerId } from '@libp2p/peer-id';\nimport { equals as uint8arrayEquals } from 'uint8arrays/equals';\nimport { CustomEvent } from '@libp2p/interfaces/events';\nconst log = logger('libp2p:peer-store:key-book');\nconst EVENT_NAME = 'change:pubkey';\nexport class PeerStoreKeyBook {\n  /**\n   * The KeyBook is responsible for keeping the known public keys of a peer\n   */\n  constructor(dispatchEvent, store) {\n    this.dispatchEvent = dispatchEvent;\n    this.store = store;\n  }\n  /**\n   * Set the Peer public key\n   */\n  async set(peerId, publicKey) {\n    peerId = peerIdFromPeerId(peerId);\n    if (!(publicKey instanceof Uint8Array)) {\n      log.error('publicKey must be an instance of Uint8Array to store data');\n      throw new CodeError('publicKey must be an instance of PublicKey', codes.ERR_INVALID_PARAMETERS);\n    }\n    log.trace('set await write lock');\n    const release = await this.store.lock.writeLock();\n    log.trace('set got write lock');\n    let updatedKey = false;\n    let peer;\n    try {\n      try {\n        peer = await this.store.load(peerId);\n        if (peer.pubKey != null && uint8arrayEquals(peer.pubKey, publicKey)) {\n          return;\n        }\n      } catch (err) {\n        if (err.code !== codes.ERR_NOT_FOUND) {\n          throw err;\n        }\n      }\n      await this.store.patchOrCreate(peerId, {\n        pubKey: publicKey\n      });\n      updatedKey = true;\n    } finally {\n      log.trace('set release write lock');\n      release();\n    }\n    if (updatedKey) {\n      this.dispatchEvent(new CustomEvent(EVENT_NAME, {\n        detail: {\n          peerId,\n          publicKey,\n          oldPublicKey: peer == null ? undefined : peer.pubKey\n        }\n      }));\n    }\n  }\n  /**\n   * Get Public key of the given PeerId, if stored\n   */\n  async get(peerId) {\n    peerId = peerIdFromPeerId(peerId);\n    log.trace('get await write lock');\n    const release = await this.store.lock.readLock();\n    log.trace('get got write lock');\n    try {\n      const peer = await this.store.load(peerId);\n      return peer.pubKey;\n    } catch (err) {\n      if (err.code !== codes.ERR_NOT_FOUND) {\n        throw err;\n      }\n    } finally {\n      log('get release write lock');\n      release();\n    }\n  }\n  async delete(peerId) {\n    peerId = peerIdFromPeerId(peerId);\n    log.trace('delete await write lock');\n    const release = await this.store.lock.writeLock();\n    log.trace('delete got write lock');\n    let peer;\n    try {\n      try {\n        peer = await this.store.load(peerId);\n      } catch (err) {\n        if (err.code !== codes.ERR_NOT_FOUND) {\n          throw err;\n        }\n      }\n      await this.store.patchOrCreate(peerId, {\n        pubKey: undefined\n      });\n    } catch (err) {\n      if (err.code !== codes.ERR_NOT_FOUND) {\n        throw err;\n      }\n    } finally {\n      log.trace('delete release write lock');\n      release();\n    }\n    this.dispatchEvent(new CustomEvent(EVENT_NAME, {\n      detail: {\n        peerId,\n        publicKey: undefined,\n        oldPublicKey: peer == null ? undefined : peer.pubKey\n      }\n    }));\n  }\n}","map":{"version":3,"names":["logger","CodeError","codes","peerIdFromPeerId","equals","uint8arrayEquals","CustomEvent","log","EVENT_NAME","PeerStoreKeyBook","constructor","dispatchEvent","store","set","peerId","publicKey","Uint8Array","error","ERR_INVALID_PARAMETERS","trace","release","lock","writeLock","updatedKey","peer","load","pubKey","err","code","ERR_NOT_FOUND","patchOrCreate","detail","oldPublicKey","undefined","get","readLock","delete"],"sources":["../../src/key-book.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}