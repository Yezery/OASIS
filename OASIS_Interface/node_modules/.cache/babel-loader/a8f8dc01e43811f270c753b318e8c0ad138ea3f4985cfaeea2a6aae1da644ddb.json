{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\n/* global EventTarget Event */\nimport defer from 'p-defer';\nconst CustomEvent = globalThis.CustomEvent ?? Event;\n/**\n * Takes an (async) iterator that emits promise-returning functions,\n * invokes them in parallel and emits the results as they become available but\n * in the same order as the input\n */\nexport default async function* parallel(source, options = {}) {\n  let concurrency = options.concurrency ?? Infinity;\n  if (concurrency < 1) {\n    concurrency = Infinity;\n  }\n  const ordered = options.ordered == null ? false : options.ordered;\n  const emitter = new EventTarget();\n  const ops = [];\n  let slotAvailable = defer();\n  let resultAvailable = defer();\n  let sourceFinished = false;\n  let sourceErr;\n  let opErred = false;\n  emitter.addEventListener('task-complete', () => {\n    resultAvailable.resolve();\n  });\n  void Promise.resolve().then(async () => {\n    try {\n      for await (const task of source) {\n        if (ops.length === concurrency) {\n          slotAvailable = defer();\n          await slotAvailable.promise;\n        }\n        if (opErred) {\n          break;\n        }\n        const op = {\n          done: false\n        };\n        ops.push(op);\n        task().then(result => {\n          op.done = true;\n          op.ok = true;\n          op.value = result;\n          emitter.dispatchEvent(new CustomEvent('task-complete'));\n        }, err => {\n          op.done = true;\n          op.err = err;\n          emitter.dispatchEvent(new CustomEvent('task-complete'));\n        });\n      }\n      sourceFinished = true;\n      emitter.dispatchEvent(new CustomEvent('task-complete'));\n    } catch (err) {\n      sourceErr = err;\n      emitter.dispatchEvent(new CustomEvent('task-complete'));\n    }\n  });\n  function valuesAvailable() {\n    if (ordered) {\n      return ops[0]?.done;\n    }\n    return Boolean(ops.find(op => op.done));\n  }\n  function* yieldOrderedValues() {\n    while (ops.length > 0 && ops[0].done) {\n      const op = ops[0];\n      ops.shift();\n      if (op.ok) {\n        yield op.value;\n      } else {\n        // allow the source to exit\n        opErred = true;\n        slotAvailable.resolve();\n        throw op.err;\n      }\n      slotAvailable.resolve();\n    }\n  }\n  function* yieldUnOrderedValues() {\n    // more values can become available while we wait for `yield`\n    // to return control to this function\n    while (valuesAvailable()) {\n      for (let i = 0; i < ops.length; i++) {\n        if (ops[i].done) {\n          const op = ops[i];\n          ops.splice(i, 1);\n          i--;\n          if (op.ok) {\n            yield op.value;\n          } else {\n            opErred = true;\n            slotAvailable.resolve();\n            throw op.err;\n          }\n          slotAvailable.resolve();\n        }\n      }\n    }\n  }\n  while (true) {\n    if (!valuesAvailable()) {\n      resultAvailable = defer();\n      await resultAvailable.promise;\n    }\n    if (sourceErr != null) {\n      // the source threw an error, propagate it\n      throw sourceErr;\n    }\n    if (ordered) {\n      yield* yieldOrderedValues();\n    } else {\n      yield* yieldUnOrderedValues();\n    }\n    if (sourceFinished && ops.length === 0) {\n      // not waiting for any results and no more tasks so we are done\n      break;\n    }\n  }\n}","map":{"version":3,"names":["defer","CustomEvent","globalThis","Event","parallel","source","options","concurrency","Infinity","ordered","emitter","EventTarget","ops","slotAvailable","resultAvailable","sourceFinished","sourceErr","opErred","addEventListener","resolve","Promise","then","task","length","promise","op","done","push","result","ok","value","dispatchEvent","err","valuesAvailable","Boolean","find","yieldOrderedValues","shift","yieldUnOrderedValues","i","splice"],"sources":["../../src/index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}