{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { MessageTypeNames, MessageTypes } from './message-types.js';\nimport { Uint8ArrayList } from 'uint8arraylist';\nexport const MAX_MSG_SIZE = 1 << 20; // 1MB\nexport const MAX_MSG_QUEUE_SIZE = 4 << 20; // 4MB\nexport class Decoder {\n  constructor(maxMessageSize = MAX_MSG_SIZE, maxUnprocessedMessageQueueSize = MAX_MSG_QUEUE_SIZE) {\n    this._buffer = new Uint8ArrayList();\n    this._headerInfo = null;\n    this._maxMessageSize = maxMessageSize;\n    this._maxUnprocessedMessageQueueSize = maxUnprocessedMessageQueueSize;\n  }\n  write(chunk) {\n    if (chunk == null || chunk.length === 0) {\n      return [];\n    }\n    this._buffer.append(chunk);\n    if (this._buffer.byteLength > this._maxUnprocessedMessageQueueSize) {\n      throw Object.assign(new Error('unprocessed message queue size too large!'), {\n        code: 'ERR_MSG_QUEUE_TOO_BIG'\n      });\n    }\n    const msgs = [];\n    while (this._buffer.length !== 0) {\n      if (this._headerInfo == null) {\n        try {\n          this._headerInfo = this._decodeHeader(this._buffer);\n        } catch (err) {\n          if (err.code === 'ERR_MSG_TOO_BIG') {\n            throw err;\n          }\n          break; // We haven't received enough data yet\n        }\n      }\n\n      const {\n        id,\n        type,\n        length,\n        offset\n      } = this._headerInfo;\n      const bufferedDataLength = this._buffer.length - offset;\n      if (bufferedDataLength < length) {\n        break; // not enough data yet\n      }\n\n      const msg = {\n        id,\n        type\n      };\n      if (type === MessageTypes.NEW_STREAM || type === MessageTypes.MESSAGE_INITIATOR || type === MessageTypes.MESSAGE_RECEIVER) {\n        msg.data = this._buffer.sublist(offset, offset + length);\n      }\n      msgs.push(msg);\n      this._buffer.consume(offset + length);\n      this._headerInfo = null;\n    }\n    return msgs;\n  }\n  /**\n   * Attempts to decode the message header from the buffer\n   */\n  _decodeHeader(data) {\n    const {\n      value: h,\n      offset\n    } = readVarInt(data);\n    const {\n      value: length,\n      offset: end\n    } = readVarInt(data, offset);\n    const type = h & 7;\n    // @ts-expect-error h is a number not a CODE\n    if (MessageTypeNames[type] == null) {\n      throw new Error(`Invalid type received: ${type}`);\n    }\n    // test message type varint + data length\n    if (length > this._maxMessageSize) {\n      throw Object.assign(new Error('message size too large!'), {\n        code: 'ERR_MSG_TOO_BIG'\n      });\n    }\n    // @ts-expect-error h is a number not a CODE\n    return {\n      id: h >> 3,\n      type,\n      offset: offset + end,\n      length\n    };\n  }\n}\nconst MSB = 0x80;\nconst REST = 0x7F;\nfunction readVarInt(buf, offset = 0) {\n  let res = 0;\n  let shift = 0;\n  let counter = offset;\n  let b;\n  const l = buf.length;\n  do {\n    if (counter >= l || shift > 49) {\n      offset = 0;\n      throw new RangeError('Could not decode varint');\n    }\n    b = buf.get(counter++);\n    res += shift < 28 ? (b & REST) << shift : (b & REST) * Math.pow(2, shift);\n    shift += 7;\n  } while (b >= MSB);\n  offset = counter - offset;\n  return {\n    value: res,\n    offset\n  };\n}","map":{"version":3,"names":["MessageTypeNames","MessageTypes","Uint8ArrayList","MAX_MSG_SIZE","MAX_MSG_QUEUE_SIZE","Decoder","constructor","maxMessageSize","maxUnprocessedMessageQueueSize","_buffer","_headerInfo","_maxMessageSize","_maxUnprocessedMessageQueueSize","write","chunk","length","append","byteLength","Object","assign","Error","code","msgs","_decodeHeader","err","id","type","offset","bufferedDataLength","msg","NEW_STREAM","MESSAGE_INITIATOR","MESSAGE_RECEIVER","data","sublist","push","consume","value","h","readVarInt","end","MSB","REST","buf","res","shift","counter","b","l","RangeError","get","Math","pow"],"sources":["../../src/decode.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}