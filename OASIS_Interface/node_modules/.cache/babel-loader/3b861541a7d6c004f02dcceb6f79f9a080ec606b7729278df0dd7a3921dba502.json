{"ast":null,"code":"import { EventEmitter } from '@libp2p/interfaces/events';\nimport errCode from 'err-code';\nexport class WebRTCHandshake extends EventEmitter {\n  constructor(options) {\n    super();\n    this.log = options.log;\n    this.peerConnection = options.peerConnection;\n    this.wrtc = options.wrtc;\n    this.status = 'idle';\n    this.peerConnection.addEventListener('negotiationneeded', () => {\n      this.log('peer connection negotiation needed');\n      this.handleRenegotiate({\n        type: 'renegotiate'\n      }).catch(err => {\n        this.log.error('could not renegotiate %o', err);\n      });\n    });\n  }\n  async handleSignal(signal) {\n    this.log('incoming signal \"%s\"', signal.type);\n    if (signal.type === 'offer') {\n      return await this.handleOffer(signal);\n    } else if (signal.type === 'answer') {\n      return await this.handleAnswer(signal);\n    } else if (signal.type === 'candidate') {\n      return await this.handleCandidate(signal);\n    } else if (signal.type === 'renegotiate') {\n      return await this.handleRenegotiate(signal);\n    } else if (signal.type === 'goodbye') {\n      return await this.handleGoodye(signal);\n    } else {\n      // @ts-expect-error all types are handled above\n      this.log(`Unknown signal type ${signal.type}`); // eslint-disable-line @typescript-eslint/restrict-template-expressions\n    }\n  }\n\n  async handleOffer(signal) {}\n  async handleAnswer(signal) {}\n  async handleRenegotiate(signal) {}\n  async handleGoodye(signal) {\n    this.peerConnection.close();\n  }\n  async handleCandidate(signal) {\n    const iceCandidate = new this.wrtc.RTCIceCandidate(signal.candidate);\n    try {\n      await this.peerConnection.addIceCandidate(iceCandidate);\n    } catch (err) {\n      if (iceCandidate.address == null || iceCandidate.address.endsWith('.local')) {\n        this.log('ignoring unsupported ICE candidate.');\n      } else {\n        throw errCode(err, 'ERR_ADD_ICE_CANDIDATE');\n      }\n    }\n  }\n}","map":{"version":3,"names":["EventEmitter","errCode","WebRTCHandshake","constructor","options","log","peerConnection","wrtc","status","addEventListener","handleRenegotiate","type","catch","err","error","handleSignal","signal","handleOffer","handleAnswer","handleCandidate","handleGoodye","close","iceCandidate","RTCIceCandidate","candidate","addIceCandidate","address","endsWith"],"sources":["../../src/handshake.ts"],"sourcesContent":[null],"mappings":"AAAA,SAASA,YAAY,QAAQ,2BAA2B;AACxD,OAAOC,OAAO,MAAM,UAAU;AAW9B,OAAM,MAAOC,eAAgB,SAAQF,YAA8B;EAMjEG,YAAaC,OAA+B;IAC1C,KAAK,EAAE;IAEP,IAAI,CAACC,GAAG,GAAGD,OAAO,CAACC,GAAG;IACtB,IAAI,CAACC,cAAc,GAAGF,OAAO,CAACE,cAAc;IAC5C,IAAI,CAACC,IAAI,GAAGH,OAAO,CAACG,IAAI;IACxB,IAAI,CAACC,MAAM,GAAG,MAAM;IAEpB,IAAI,CAACF,cAAc,CAACG,gBAAgB,CAAC,mBAAmB,EAAE,MAAK;MAC7D,IAAI,CAACJ,GAAG,CAAC,oCAAoC,CAAC;MAE9C,IAAI,CAACK,iBAAiB,CAAC;QAAEC,IAAI,EAAE;MAAa,CAAE,CAAC,CAACC,KAAK,CAACC,GAAG,IAAG;QAC1D,IAAI,CAACR,GAAG,CAACS,KAAK,CAAC,0BAA0B,EAAED,GAAG,CAAC;MACjD,CAAC,CAAC;IACJ,CAAC,CAAC;EACJ;EAEA,MAAME,YAAYA,CAAEC,MAAc;IAChC,IAAI,CAACX,GAAG,CAAC,sBAAsB,EAAEW,MAAM,CAACL,IAAI,CAAC;IAE7C,IAAIK,MAAM,CAACL,IAAI,KAAK,OAAO,EAAE;MAC3B,OAAO,MAAM,IAAI,CAACM,WAAW,CAACD,MAAM,CAAC;KACtC,MAAM,IAAIA,MAAM,CAACL,IAAI,KAAK,QAAQ,EAAE;MACnC,OAAO,MAAM,IAAI,CAACO,YAAY,CAACF,MAAM,CAAC;KACvC,MAAM,IAAIA,MAAM,CAACL,IAAI,KAAK,WAAW,EAAE;MACtC,OAAO,MAAM,IAAI,CAACQ,eAAe,CAACH,MAAM,CAAC;KAC1C,MAAM,IAAIA,MAAM,CAACL,IAAI,KAAK,aAAa,EAAE;MACxC,OAAO,MAAM,IAAI,CAACD,iBAAiB,CAACM,MAAM,CAAC;KAC5C,MAAM,IAAIA,MAAM,CAACL,IAAI,KAAK,SAAS,EAAE;MACpC,OAAO,MAAM,IAAI,CAACS,YAAY,CAACJ,MAAM,CAAC;KACvC,MAAM;MACL;MACA,IAAI,CAACX,GAAG,CAAC,uBAAuBW,MAAM,CAACL,IAAI,EAAE,CAAC,EAAC;;EAEnD;;EAEA,MAAMM,WAAWA,CAAED,MAAmB,GAAG;EACzC,MAAME,YAAYA,CAAEF,MAAoB,GAAG;EAC3C,MAAMN,iBAAiBA,CAAEM,MAAyB,GAAG;EACrD,MAAMI,YAAYA,CAAEJ,MAAqB;IACvC,IAAI,CAACV,cAAc,CAACe,KAAK,EAAE;EAC7B;EAEA,MAAMF,eAAeA,CAAEH,MAAuB;IAC5C,MAAMM,YAAY,GAAG,IAAI,IAAI,CAACf,IAAI,CAACgB,eAAe,CAACP,MAAM,CAACQ,SAAS,CAAC;IAEpE,IAAI;MACF,MAAM,IAAI,CAAClB,cAAc,CAACmB,eAAe,CAACH,YAAY,CAAC;KACxD,CAAC,OAAOT,GAAG,EAAE;MACZ,IAAIS,YAAY,CAACI,OAAO,IAAI,IAAI,IAAIJ,YAAY,CAACI,OAAO,CAACC,QAAQ,CAAC,QAAQ,CAAC,EAAE;QAC3E,IAAI,CAACtB,GAAG,CAAC,qCAAqC,CAAC;OAChD,MAAM;QACL,MAAMJ,OAAO,CAACY,GAAG,EAAE,uBAAuB,CAAC;;;EAGjD"},"metadata":{},"sourceType":"module","externalDependencies":[]}