(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Libp2PDelegatedContentRouting = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Libp2PDelegatedContentRouting=(()=>{var ut=Object.create;var ie=Object.defineProperty;var ct=Object.getOwnPropertyDescriptor;var ft=Object.getOwnPropertyNames;var lt=Object.getPrototypeOf,ht=Object.prototype.hasOwnProperty;var Y=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),dt=(t,e)=>{for(var r in e)ie(t,r,{get:e[r],enumerable:!0})},Ne=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ft(e))!ht.call(t,i)&&i!==r&&ie(t,i,{get:()=>e[i],enumerable:!(n=ct(e,i))||n.enumerable});return t};var we=(t,e,r)=>(r=t!=null?ut(lt(t)):{},Ne(e||!t||!t.__esModule?ie(r,"default",{value:t,enumerable:!0}):r,t)),pt=t=>Ne(ie({},"__esModule",{value:!0}),t);var Te=Y((Gt,Ue)=>{var j=1e3,W=j*60,q=W*60,V=q*24,mt=V*7,bt=V*365.25;Ue.exports=function(t,e){e=e||{};var r=typeof t;if(r==="string"&&t.length>0)return wt(t);if(r==="number"&&isFinite(t))return e.long?gt(t):vt(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function wt(t){if(t=String(t),!(t.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(e){var r=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return r*bt;case"weeks":case"week":case"w":return r*mt;case"days":case"day":case"d":return r*V;case"hours":case"hour":case"hrs":case"hr":case"h":return r*q;case"minutes":case"minute":case"mins":case"min":case"m":return r*W;case"seconds":case"second":case"secs":case"sec":case"s":return r*j;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}function vt(t){var e=Math.abs(t);return e>=V?Math.round(t/V)+"d":e>=q?Math.round(t/q)+"h":e>=W?Math.round(t/W)+"m":e>=j?Math.round(t/j)+"s":t+"ms"}function gt(t){var e=Math.abs(t);return e>=V?oe(t,e,V,"day"):e>=q?oe(t,e,q,"hour"):e>=W?oe(t,e,W,"minute"):e>=j?oe(t,e,j,"second"):t+" ms"}function oe(t,e,r,n){var i=e>=r*1.5;return Math.round(t/r)+" "+n+(i?"s":"")}});var Le=Y((jt,De)=>{function Ct(t){r.debug=r,r.default=r,r.coerce=s,r.disable=o,r.enable=i,r.enabled=a,r.humanize=Te(),r.destroy=v,Object.keys(t).forEach(c=>{r[c]=t[c]}),r.names=[],r.skips=[],r.formatters={};function e(c){let f=0;for(let p=0;p<c.length;p++)f=(f<<5)-f+c.charCodeAt(p),f|=0;return r.colors[Math.abs(f)%r.colors.length]}r.selectColor=e;function r(c){let f,p=null,R,h;function d(...w){if(!d.enabled)return;let g=d,_=Number(new Date),Q=_-(f||_);g.diff=Q,g.prev=f,g.curr=_,f=_,w[0]=r.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let C=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(N,F)=>{if(N==="%%")return"%";C++;let U=r.formatters[F];if(typeof U=="function"){let G=w[C];N=U.call(g,G),w.splice(C,1),C--}return N}),r.formatArgs.call(g,w),(g.log||r.log).apply(g,w)}return d.namespace=c,d.useColors=r.useColors(),d.color=r.selectColor(c),d.extend=n,d.destroy=r.destroy,Object.defineProperty(d,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(R!==r.namespaces&&(R=r.namespaces,h=r.enabled(c)),h),set:w=>{p=w}}),typeof r.init=="function"&&r.init(d),d}function n(c,f){let p=r(this.namespace+(typeof f>"u"?":":f)+c);return p.log=this.log,p}function i(c){r.save(c),r.namespaces=c,r.names=[],r.skips=[];let f,p=(typeof c=="string"?c:"").split(/[\s,]+/),R=p.length;for(f=0;f<R;f++)p[f]&&(c=p[f].replace(/\*/g,".*?"),c[0]==="-"?r.skips.push(new RegExp("^"+c.slice(1)+"$")):r.names.push(new RegExp("^"+c+"$")))}function o(){let c=[...r.names.map(l),...r.skips.map(l).map(f=>"-"+f)].join(",");return r.enable(""),c}function a(c){if(c[c.length-1]==="*")return!0;let f,p;for(f=0,p=r.skips.length;f<p;f++)if(r.skips[f].test(c))return!1;for(f=0,p=r.names.length;f<p;f++)if(r.names[f].test(c))return!0;return!1}function l(c){return c.toString().substring(2,c.toString().length-2).replace(/\.\*\?$/,"*")}function s(c){return c instanceof Error?c.stack||c.message:c}function v(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}De.exports=Ct});var ze=Y((A,se)=>{A.formatArgs=_t;A.save=Et;A.load=xt;A.useColors=yt;A.storage=Pt();A.destroy=(()=>{let t=!1;return()=>{t||(t=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();A.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function yt(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function _t(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+se.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;t.splice(1,0,e,"color: inherit");let r=0,n=0;t[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(r++,i==="%c"&&(n=r))}),t.splice(n,0,e)}A.log=console.debug||console.log||(()=>{});function Et(t){try{t?A.storage.setItem("debug",t):A.storage.removeItem("debug")}catch{}}function xt(){let t;try{t=A.storage.getItem("debug")}catch{}return!t&&typeof process<"u"&&"env"in process&&(t=process.env.DEBUG),t}function Pt(){try{return localStorage}catch{}}se.exports=Le()(A);var{formatters:Ft}=se.exports;Ft.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Je=Y((Cr,Ye)=>{"use strict";function Be(t,e){for(let r in e)Object.defineProperty(t,r,{value:e[r],enumerable:!0,configurable:!0});return t}function Nt(t,e,r){if(!t||typeof t=="string")throw new TypeError("Please pass an Error to err-code");r||(r={}),typeof e=="object"&&(r=e,e=""),e&&(r.code=e);try{return Be(t,r)}catch{r.message=t.message,r.stack=t.stack;let i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(t)),Be(new i,r)}}Ye.exports=Nt});var Ze=Y((Er,xe)=>{"use strict";var Dt=Object.prototype.hasOwnProperty,x="~";function X(){}Object.create&&(X.prototype=Object.create(null),new X().__proto__||(x=!1));function Lt(t,e,r){this.fn=t,this.context=e,this.once=r||!1}function Xe(t,e,r,n,i){if(typeof r!="function")throw new TypeError("The listener must be a function");var o=new Lt(r,n||t,i),a=x?x+e:e;return t._events[a]?t._events[a].fn?t._events[a]=[t._events[a],o]:t._events[a].push(o):(t._events[a]=o,t._eventsCount++),t}function ae(t,e){--t._eventsCount===0?t._events=new X:delete t._events[e]}function y(){this._events=new X,this._eventsCount=0}y.prototype.eventNames=function(){var e=[],r,n;if(this._eventsCount===0)return e;for(n in r=this._events)Dt.call(r,n)&&e.push(x?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(r)):e};y.prototype.listeners=function(e){var r=x?x+e:e,n=this._events[r];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,o=n.length,a=new Array(o);i<o;i++)a[i]=n[i].fn;return a};y.prototype.listenerCount=function(e){var r=x?x+e:e,n=this._events[r];return n?n.fn?1:n.length:0};y.prototype.emit=function(e,r,n,i,o,a){var l=x?x+e:e;if(!this._events[l])return!1;var s=this._events[l],v=arguments.length,c,f;if(s.fn){switch(s.once&&this.removeListener(e,s.fn,void 0,!0),v){case 1:return s.fn.call(s.context),!0;case 2:return s.fn.call(s.context,r),!0;case 3:return s.fn.call(s.context,r,n),!0;case 4:return s.fn.call(s.context,r,n,i),!0;case 5:return s.fn.call(s.context,r,n,i,o),!0;case 6:return s.fn.call(s.context,r,n,i,o,a),!0}for(f=1,c=new Array(v-1);f<v;f++)c[f-1]=arguments[f];s.fn.apply(s.context,c)}else{var p=s.length,R;for(f=0;f<p;f++)switch(s[f].once&&this.removeListener(e,s[f].fn,void 0,!0),v){case 1:s[f].fn.call(s[f].context);break;case 2:s[f].fn.call(s[f].context,r);break;case 3:s[f].fn.call(s[f].context,r,n);break;case 4:s[f].fn.call(s[f].context,r,n,i);break;default:if(!c)for(R=1,c=new Array(v-1);R<v;R++)c[R-1]=arguments[R];s[f].fn.apply(s[f].context,c)}}return!0};y.prototype.on=function(e,r,n){return Xe(this,e,r,n,!1)};y.prototype.once=function(e,r,n){return Xe(this,e,r,n,!0)};y.prototype.removeListener=function(e,r,n,i){var o=x?x+e:e;if(!this._events[o])return this;if(!r)return ae(this,o),this;var a=this._events[o];if(a.fn)a.fn===r&&(!i||a.once)&&(!n||a.context===n)&&ae(this,o);else{for(var l=0,s=[],v=a.length;l<v;l++)(a[l].fn!==r||i&&!a[l].once||n&&a[l].context!==n)&&s.push(a[l]);s.length?this._events[o]=s.length===1?s[0]:s:ae(this,o)}return this};y.prototype.removeAllListeners=function(e){var r;return e?(r=x?x+e:e,this._events[r]&&ae(this,r)):(this._events=new X,this._eventsCount=0),this};y.prototype.off=y.prototype.removeListener;y.prototype.addListener=y.prototype.on;y.prefixed=x;y.EventEmitter=y;typeof xe<"u"&&(xe.exports=y)});var Vt={};dt(Vt,{EventTypes:()=>Oe,MessageType:()=>Re,delegatedContentRouting:()=>Mt});var I=we(ze(),1);function At(t,e){if(t.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),n=0;n<r.length;n++)r[n]=255;for(var i=0;i<t.length;i++){var o=t.charAt(i),a=o.charCodeAt(0);if(r[a]!==255)throw new TypeError(o+" is ambiguous");r[a]=i}var l=t.length,s=t.charAt(0),v=Math.log(l)/Math.log(256),c=Math.log(256)/Math.log(l);function f(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var d=0,w=0,g=0,_=h.length;g!==_&&h[g]===0;)g++,d++;for(var Q=(_-g)*c+1>>>0,C=new Uint8Array(Q);g!==_;){for(var T=h[g],N=0,F=Q-1;(T!==0||N<w)&&F!==-1;F--,N++)T+=256*C[F]>>>0,C[F]=T%l>>>0,T=T/l>>>0;if(T!==0)throw new Error("Non-zero carry");w=N,g++}for(var U=Q-w;U!==Q&&C[U]===0;)U++;for(var G=s.repeat(d);U<Q;++U)G+=t.charAt(C[U]);return G}function p(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var d=0;if(h[d]!==" "){for(var w=0,g=0;h[d]===s;)w++,d++;for(var _=(h.length-d)*v+1>>>0,Q=new Uint8Array(_);h[d];){var C=r[h.charCodeAt(d)];if(C===255)return;for(var T=0,N=_-1;(C!==0||T<g)&&N!==-1;N--,T++)C+=l*Q[N]>>>0,Q[N]=C%256>>>0,C=C/256>>>0;if(C!==0)throw new Error("Non-zero carry");g=T,d++}if(h[d]!==" "){for(var F=_-g;F!==_&&Q[F]===0;)F++;for(var U=new Uint8Array(w+(_-F)),G=w;F!==_;)U[G++]=Q[F++];return U}}}function R(h){var d=p(h);if(d)return d;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:p,decode:R}}var It=At,St=It,ke=St;var qt=new Uint8Array(0);var Me=t=>{if(t instanceof Uint8Array&&t.constructor.name==="Uint8Array")return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(ArrayBuffer.isView(t))return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);throw new Error("Unknown type, must be binary type")};var ve=class{constructor(e,r,n){this.name=e,this.prefix=r,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ge=class{constructor(e,r,n){if(this.name=e,this.prefix=r,r.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=r.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Ve(this,e)}},Ce=class{constructor(e){this.decoders=e}or(e){return Ve(this,e)}decode(e){let r=e[0],n=this.decoders[r];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},Ve=(t,e)=>new Ce({...t.decoders||{[t.prefix]:t},...e.decoders||{[e.prefix]:e}}),ye=class{constructor(e,r,n,i){this.name=e,this.prefix=r,this.baseEncode=n,this.baseDecode=i,this.encoder=new ve(e,r,n),this.decoder=new ge(e,r,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},$e=({name:t,prefix:e,encode:r,decode:n})=>new ye(t,e,r,n),_e=({prefix:t,name:e,alphabet:r})=>{let{encode:n,decode:i}=ke(r,e);return $e({prefix:t,name:e,encode:n,decode:o=>Me(i(o))})},Ot=(t,e,r,n)=>{let i={};for(let c=0;c<e.length;++c)i[e[c]]=c;let o=t.length;for(;t[o-1]==="=";)--o;let a=new Uint8Array(o*r/8|0),l=0,s=0,v=0;for(let c=0;c<o;++c){let f=i[t[c]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);s=s<<r|f,l+=r,l>=8&&(l-=8,a[v++]=255&s>>l)}if(l>=r||255&s<<8-l)throw new SyntaxError("Unexpected end of data");return a},Rt=(t,e,r)=>{let n=e[e.length-1]==="=",i=(1<<r)-1,o="",a=0,l=0;for(let s=0;s<t.length;++s)for(l=l<<8|t[s],a+=8;a>r;)a-=r,o+=e[i&l>>a];if(a&&(o+=e[i&l<<r-a]),n)for(;o.length*r&7;)o+="=";return o},E=({name:t,prefix:e,bitsPerChar:r,alphabet:n})=>$e({prefix:e,name:t,encode(i){return Rt(i,n,r)},decode(i){return Ot(i,n,r,t)}});var Ge=E({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Kt=E({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Ht=E({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),er=E({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),tr=E({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),rr=E({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),nr=E({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),ir=E({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),or=E({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var je=_e({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ur=_e({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var We=E({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),lr=E({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),hr=E({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),dr=E({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});I.default.formatters.b=t=>t==null?"undefined":je.baseEncode(t);I.default.formatters.t=t=>t==null?"undefined":Ge.baseEncode(t);I.default.formatters.m=t=>t==null?"undefined":We.baseEncode(t);I.default.formatters.p=t=>t==null?"undefined":t.toString();I.default.formatters.c=t=>t==null?"undefined":t.toString();I.default.formatters.k=t=>t==null?"undefined":t.toString();I.default.formatters.a=t=>t==null?"undefined":t.toString();function Qt(t){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=t,e.destroy=()=>!0,e.extend=()=>e,e}function qe(t){let e=Qt(`${t}:trace`);return I.default.enabled(`${t}:trace`)&&I.default.names.map(r=>r.toString()).find(r=>r.includes(":trace"))!=null&&(e=(0,I.default)(`${t}:trace`)),Object.assign((0,I.default)(t),{error:(0,I.default)(`${t}:error`),trace:e})}function J(t){let e=new globalThis.AbortController;function r(){e.abort();for(let o of t)o?.removeEventListener!=null&&o.removeEventListener("abort",r)}for(let o of t){if(o?.aborted===!0){r();break}o?.addEventListener!=null&&o.addEventListener("abort",r)}function n(){for(let o of t)o?.removeEventListener!=null&&o.removeEventListener("abort",r)}let i=e.signal;return i.clear=n,i}var at=we(Je(),1);function Ut(t){return t[Symbol.asyncIterator]!=null}function Tt(t){if(Ut(t))return(async()=>{for await(let e of t);})();for(let e of t);}var Ee=Tt;function L(){let t={};return t.promise=new Promise((e,r)=>{t.resolve=e,t.reject=r}),t}var st=we(Ze(),1);var Z=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Pe=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},Ke=t=>globalThis.DOMException===void 0?new Pe(t):new DOMException(t),He=t=>{let e=t.reason===void 0?Ke("This operation was aborted."):t.reason;return e instanceof Error?e:Ke(e)};function Fe(t,e,r,n){let i,o=new Promise((a,l)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(e===Number.POSITIVE_INFINITY){a(t);return}if(n={customTimers:{setTimeout,clearTimeout},...n},n.signal){let{signal:s}=n;s.aborted&&l(He(s)),s.addEventListener("abort",()=>{l(He(s))})}i=n.customTimers.setTimeout.call(void 0,()=>{if(typeof r=="function"){try{a(r())}catch(c){l(c)}return}let s=typeof r=="string"?r:`Promise timed out after ${e} milliseconds`,v=r instanceof Error?r:new Z(s);typeof t.cancel=="function"&&t.cancel(),l(v)},e),(async()=>{try{a(await t)}catch(s){l(s)}finally{n.customTimers.clearTimeout.call(void 0,i)}})()});return o.clear=()=>{clearTimeout(i),i=void 0},o}function Ae(t,e,r){let n=0,i=t.length;for(;i>0;){let o=Math.trunc(i/2),a=n+o;r(t[a],e)<=0?(n=++a,i-=o+1):i=o}return n}var $=function(t,e,r,n){if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?n:r==="a"?n.call(t):n?n.value:e.get(t)},z,K=class{constructor(){z.set(this,[])}enqueue(e,r){r={priority:0,...r};let n={priority:r.priority,run:e};if(this.size&&$(this,z,"f")[this.size-1].priority>=r.priority){$(this,z,"f").push(n);return}let i=Ae($(this,z,"f"),n,(o,a)=>a.priority-o.priority);$(this,z,"f").splice(i,0,n)}dequeue(){let e=$(this,z,"f").shift();return e?.run}filter(e){return $(this,z,"f").filter(r=>r.priority===e.priority).map(r=>r.run)}get size(){return $(this,z,"f").length}};z=new WeakMap;var m=function(t,e,r,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!i:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(t,r):i?i.value=r:e.set(t,r),r},u=function(t,e,r,n){if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?n:r==="a"?n.call(t):n?n.value:e.get(t)},b,ee,te,M,de,re,ue,D,H,S,ce,O,ne,k,fe,et,tt,it,rt,nt,le,Ie,Se,pe,ot,he,me=class extends Error{},B=class extends st.default{constructor(e){var r,n,i,o;if(super(),b.add(this),ee.set(this,void 0),te.set(this,void 0),M.set(this,0),de.set(this,void 0),re.set(this,void 0),ue.set(this,0),D.set(this,void 0),H.set(this,void 0),S.set(this,void 0),ce.set(this,void 0),O.set(this,0),ne.set(this,void 0),k.set(this,void 0),fe.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:K,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(r=e.intervalCap)===null||r===void 0?void 0:r.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(o=(i=e.interval)===null||i===void 0?void 0:i.toString())!==null&&o!==void 0?o:""}\` (${typeof e.interval})`);m(this,ee,e.carryoverConcurrencyCount,"f"),m(this,te,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,"f"),m(this,de,e.intervalCap,"f"),m(this,re,e.interval,"f"),m(this,S,new e.queueClass,"f"),m(this,ce,e.queueClass,"f"),this.concurrency=e.concurrency,this.timeout=e.timeout,m(this,fe,e.throwOnTimeout===!0,"f"),m(this,k,e.autoStart===!1,"f")}get concurrency(){return u(this,ne,"f")}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);m(this,ne,e,"f"),u(this,b,"m",pe).call(this)}async add(e,r={}){return r={timeout:this.timeout,throwOnTimeout:u(this,fe,"f"),...r},new Promise((n,i)=>{u(this,S,"f").enqueue(async()=>{var o,a,l;m(this,O,(a=u(this,O,"f"),a++,a),"f"),m(this,M,(l=u(this,M,"f"),l++,l),"f");try{if(!((o=r.signal)===null||o===void 0)&&o.aborted)throw new me("The task was aborted.");let s=e({signal:r.signal});r.timeout&&(s=Fe(Promise.resolve(s),r.timeout)),r.signal&&(s=Promise.race([s,u(this,b,"m",ot).call(this,r.signal)]));let v=await s;n(v),this.emit("completed",v)}catch(s){if(s instanceof Z&&!r.throwOnTimeout){n();return}i(s),this.emit("error",s)}finally{u(this,b,"m",it).call(this)}},r),this.emit("add"),u(this,b,"m",le).call(this)})}async addAll(e,r){return Promise.all(e.map(async n=>this.add(n,r)))}start(){return u(this,k,"f")?(m(this,k,!1,"f"),u(this,b,"m",pe).call(this),this):this}pause(){m(this,k,!0,"f")}clear(){m(this,S,new(u(this,ce,"f")),"f")}async onEmpty(){u(this,S,"f").size!==0&&await u(this,b,"m",he).call(this,"empty")}async onSizeLessThan(e){u(this,S,"f").size<e||await u(this,b,"m",he).call(this,"next",()=>u(this,S,"f").size<e)}async onIdle(){u(this,O,"f")===0&&u(this,S,"f").size===0||await u(this,b,"m",he).call(this,"idle")}get size(){return u(this,S,"f").size}sizeBy(e){return u(this,S,"f").filter(e).length}get pending(){return u(this,O,"f")}get isPaused(){return u(this,k,"f")}};ee=new WeakMap,te=new WeakMap,M=new WeakMap,de=new WeakMap,re=new WeakMap,ue=new WeakMap,D=new WeakMap,H=new WeakMap,S=new WeakMap,ce=new WeakMap,O=new WeakMap,ne=new WeakMap,k=new WeakMap,fe=new WeakMap,b=new WeakSet,et=function(){return u(this,te,"f")||u(this,M,"f")<u(this,de,"f")},tt=function(){return u(this,O,"f")<u(this,ne,"f")},it=function(){var e;m(this,O,(e=u(this,O,"f"),e--,e),"f"),u(this,b,"m",le).call(this),this.emit("next")},rt=function(){u(this,b,"m",Se).call(this),u(this,b,"m",Ie).call(this),m(this,H,void 0,"f")},nt=function(){let e=Date.now();if(u(this,D,"f")===void 0){let r=u(this,ue,"f")-e;if(r<0)m(this,M,u(this,ee,"f")?u(this,O,"f"):0,"f");else return u(this,H,"f")===void 0&&m(this,H,setTimeout(()=>{u(this,b,"m",rt).call(this)},r),"f"),!0}return!1},le=function(){if(u(this,S,"f").size===0)return u(this,D,"f")&&clearInterval(u(this,D,"f")),m(this,D,void 0,"f"),this.emit("empty"),u(this,O,"f")===0&&this.emit("idle"),!1;if(!u(this,k,"f")){let e=!u(this,b,"a",nt);if(u(this,b,"a",et)&&u(this,b,"a",tt)){let r=u(this,S,"f").dequeue();return r?(this.emit("active"),r(),e&&u(this,b,"m",Ie).call(this),!0):!1}}return!1},Ie=function(){u(this,te,"f")||u(this,D,"f")!==void 0||(m(this,D,setInterval(()=>{u(this,b,"m",Se).call(this)},u(this,re,"f")),"f"),m(this,ue,Date.now()+u(this,re,"f"),"f"))},Se=function(){u(this,M,"f")===0&&u(this,O,"f")===0&&u(this,D,"f")&&(clearInterval(u(this,D,"f")),m(this,D,void 0,"f")),m(this,M,u(this,ee,"f")?u(this,O,"f"):0,"f"),u(this,b,"m",pe).call(this)},pe=function(){for(;u(this,b,"m",le).call(this););},ot=async function(e){return new Promise((r,n)=>{e.addEventListener("abort",()=>{n(new me("The task was aborted."))},{once:!0})})},he=async function(e,r){return new Promise(n=>{let i=()=>{r&&!r()||(this.off(e,i),n())};this.on(e,i)})};var P=qe("libp2p:delegated-content-routing"),be=3e4,zt=4,kt=2,Oe;(function(t){t[t.SENDING_QUERY=0]="SENDING_QUERY",t[t.PEER_RESPONSE=1]="PEER_RESPONSE",t[t.FINAL_PEER=2]="FINAL_PEER",t[t.QUERY_ERROR=3]="QUERY_ERROR",t[t.PROVIDER=4]="PROVIDER",t[t.VALUE=5]="VALUE",t[t.ADDING_PEER=6]="ADDING_PEER",t[t.DIALING_PEER=7]="DIALING_PEER"})(Oe||(Oe={}));var Re;(function(t){t[t.PUT_VALUE=0]="PUT_VALUE",t[t.GET_VALUE=1]="GET_VALUE",t[t.ADD_PROVIDER=2]="ADD_PROVIDER",t[t.GET_PROVIDERS=3]="GET_PROVIDERS",t[t.FIND_NODE=4]="FIND_NODE",t[t.PING=5]="PING"})(Re||(Re={}));var Qe=class{client;httpQueue;httpQueueRefs;started;abortController;constructor(e){if(e==null)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new B({concurrency:zt}),this.httpQueueRefs=new B({concurrency:kt});let{protocol:r,host:n,port:i}=e.getEndpointConfig();P(`enabled DelegatedContentRouting via ${r}://${n}:${i}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.httpQueueRefs.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async*findProviders(e,r={}){P("findProviders starts: %c",e),r.timeout=r.timeout??be;let n=J([this.abortController.signal,r.signal]),i=L(),o=L();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;for await(let a of this.client.dht.findProvs(e,{...r,signal:n}))a.name==="PROVIDER"&&(yield*a.providers.map(l=>({id:l.id,protocols:[],multiaddrs:l.multiaddrs})))}catch(a){throw P.error("findProviders errored:",a),a}finally{n.clear(),o.resolve(),P("findProviders finished: %c",e)}}async provide(e,r={}){P("provide starts: %c",e),r.timeout=r.timeout??be;let n=J([this.abortController.signal,r.signal]),i=L(),o=L();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise,await this.client.block.stat(e,{...r,signal:n}),await Ee(this.client.dht.provide(e,{...r,signal:n}))}catch(a){throw P.error("provide errored:",a),a}finally{n.clear(),o.resolve(),P("provide finished: %c",e)}}async put(e,r,n={}){P("put value start: %b",e),n.timeout=n.timeout??be;let i=J([this.abortController.signal,n.signal]),o=L(),a=L();this.httpQueue.add(async()=>(o.resolve(),a.promise));try{await o.promise,await Ee(this.client.dht.put(e,r,{...n,signal:i}))}catch(l){throw P.error("put errored:",l),l}finally{i.clear(),a.resolve(),P("put finished: %b",e)}}async get(e,r={}){P("get value start: %b",e),r.timeout=r.timeout??be;let n=J([this.abortController.signal,r.signal]),i=L(),o=L();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;for await(let a of this.client.dht.get(e,{...r,signal:n}))if(a.name==="VALUE")return P("get value finished: %b",e),a.value;throw(0,at.default)(new Error("Not found"),"ERR_NOT_FOUND")}catch(a){throw P.error("put errored:",a),a}finally{n.clear(),o.resolve(),P("put finished: %b",e)}}};function Mt(t){return()=>new Qe(t)}return pt(Vt);})();
return Libp2PDelegatedContentRouting}));
